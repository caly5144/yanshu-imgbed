<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雁陎图床 - 后台管理</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <script src="/static/js/toast.js" defer></script>
    <script>
        function checkAuth() {
            if (!localStorage.getItem('jwt_token')) {
                localStorage.setItem('redirect_after_login', window.location.pathname);
                window.location.href = '/login';
            }
        }
        checkAuth();

        function fetchWithAuth(url, options) {
            options = options || {};
            options.headers = options.headers || {};
            const token = localStorage.getItem('jwt_token');
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            return fetch(url, options).then(response => {
                if (response.status === 401) {
                    // Only handle 401 for potential token expiry.
                    // Let local handlers deal with 403 (Forbidden) etc.
                    console.error("Authentication expired or invalid, redirecting...");
                    logout();
                }
                return response;
            });
        }
    </script>
</head>
<body>
    <script>document.body.classList.add('js-loading');</script>
    <div class="container">
        <div class="header">
            <h1>图床管理后台</h1>
            <div class="header-actions">
                <a href="/">📷 返回主页</a>
                <a href="#" onclick="logout()">🚪 退出登录</a>
            </div>
        </div>
        <div class="tabs">
            <!-- Tabs will be rendered by JavaScript -->
        </div>
        <div class="content">
            <div id="overview" class="section"></div>
            <div id="images" class="section"></div>
            <div id="tasks" class="section"></div>
            <div id="backends" class="section"></div>
            <div id="settings" class="section"></div>
            <div id="users" class="section"></div>
        </div>
    </div>
    <div class="modal" id="addBackendModal"></div>
    <div class="modal" id="addUserModal"></div>
    <div class="modal" id="changePasswordModal"></div>
    <div class="modal" id="createAPITokenModal"></div>
    <div class="modal" id="batchBackfillModal"></div>
    
    <script>
    let currentPage = 1;
    let selectedImages = new Set();
    let currentEditingBackendId = null;
    let userRole = ''; // Will hold 'admin' or 'user'

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const userInfoRes = await fetchWithAuth('/api/user/info');
            if (userInfoRes.ok) {
                const userInfo = await userInfoRes.json();
                userRole = userInfo.role;
                localStorage.setItem('user_id', userInfo.user_id);
                localStorage.setItem('user_role', userRole);

                renderTabsBasedOnRole();

                const lastTab = localStorage.getItem('activeAdminTab') || 'overview';
                showSection(lastTab);
            } else {
                logout();
                return;
            }
        } catch (error) {
            console.error("Initialization failed:", error);
            logout();
        } finally {
            document.body.classList.remove('js-loading');
        }
    });

    function renderTabsBasedOnRole() {
        const tabsContainer = document.querySelector('.tabs');
        let tabsHtml = `
            <button class="tab" onclick="showSection('overview')">📊 概览</button>
            <button class="tab" onclick="showSection('images')">🖼️ 图片管理</button>
        `;

        if (userRole === 'admin') {
            tabsHtml += `
                <button class="tab" onclick="showSection('tasks')">⚙️ 批量任务</button>
                <button class="tab" onclick="showSection('backends')">💾 存储后端</button>
                <button class="tab" onclick="showSection('settings')">⚡ 系统设置</button>
            `;
        }
        
        const userManagementTabText = userRole === 'admin' ? '👥 用户管理' : '👤 账户管理';
        tabsHtml += `<button class="tab" onclick="showSection('users')">${userManagementTabText}</button>`;
        
        tabsContainer.innerHTML = tabsHtml;
    }

    function showSection(sectionId) {
        const adminSections = ['tasks', 'backends', 'settings'];
        if (userRole !== 'admin' && adminSections.includes(sectionId)) {
            beautifulAlert.alert('您没有权限访问此页面。', 'error');
            sectionId = 'overview';
        }
        if (userRole !== 'admin' && !['overview', 'images', 'users'].includes(localStorage.getItem('activeAdminTab'))) {
             sectionId = 'overview';
        }

        localStorage.setItem('activeAdminTab', sectionId);
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const tabButton = document.querySelector(`.tab[onclick="showSection('${sectionId}')"]`);
        if (tabButton) tabButton.classList.add('active');
        const section = document.getElementById(sectionId);

        if (section) {
            section.classList.add('active');
            switch (sectionId) {
                case 'overview': loadOverview(); break;
                case 'images': loadImages(1); break;
                case 'tasks': if (userRole === 'admin') loadTasks(); break;
                case 'backends': if (userRole === 'admin') loadBackends(); break;
                case 'settings': if (userRole === 'admin') loadSettings(); break;
                case 'users': loadUsers(); break;
            }
        }
    }
    
    async function loadOverview() {
        const section = document.getElementById('overview');
        section.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="totalImages">...</div><div class="stat-label">总图片数</div></div>
                <div class="stat-card"><div class="stat-value" id="totalSize">...</div><div class="stat-label">总占用空间</div></div>
                <div class="stat-card"><div class="stat-value" id="totalBackends">...</div><div class="stat-label">存储后端</div></div>
                <div class="stat-card"><div class="stat-value" id="todayUploads">...</div><div class="stat-label">今日上传</div></div>
            </div>
            <h3 style="margin-bottom: 15px;">最近上传</h3>
            <div class="image-grid" id="recentImages">加载中...</div>`;
        const stats = await (await fetchWithAuth('/api/stats')).json();
        const recentData = await (await fetchWithAuth('/api/images/recent')).json();
        document.getElementById('totalImages').textContent = stats.totalImages;
        document.getElementById('totalSize').textContent = formatSize(stats.totalSize);
        document.getElementById('totalBackends').textContent = stats.totalBackends;
        document.getElementById('todayUploads').textContent = stats.todayUploads;

        const recentGrid = document.getElementById('recentImages');
        recentGrid.innerHTML = '';
        if (recentData && recentData.length > 0) {
            recentData.forEach(img => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.innerHTML = `<img src="/image/${img.UUID}.jpg" alt="${img.OriginalFilename}"><div class="image-item-info">${img.OriginalFilename}</div>`;
                recentGrid.appendChild(item);
            });
        } else {
            recentGrid.innerHTML = '<p>暂无图片</p>';
        }
    }
    
    async function loadImages(page = 1, keyword = '') { // 增加了 keyword 参数
        currentPage = page;
        const section = document.getElementById('images');
        
        let batchActionBarHTML = `
            <span>已选中 <strong id="selectionCount">0</strong> 张图片</span>
            <button class="btn btn-danger" onclick="handleBatchDelete()">批量删除</button>
            <button class="btn btn-primary" onclick="handleBatchBackfill()">批量补传</button>
        `;
        if (userRole === 'admin') {
            batchActionBarHTML += `
                <button class="btn btn-success" onclick="handleBatchSetRandom(true)">批量加入随机图库</button>
                <button class="btn btn-danger" onclick="handleBatchSetRandom(false)">批量移除随机图库</button>
            `;
        }

        section.innerHTML = `
            <div id="batchActionBar" style="margin-bottom: 15px;">${batchActionBarHTML}</div>
            <div style="margin-bottom: 15px;">
                <input id="imageSearchInput" type="text" placeholder="搜索图片..." style="width: 300px; display: inline-block;" value="${keyword}">
                <button class="btn btn-primary" onclick="searchImages()">搜索</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"></th>
                        <th>预览</th><th>文件名</th><th>尺寸</th><th>大小</th><th>上传时间</th><th>状态</th><th>操作</th>
                    </tr>
                </thead>
                <tbody id="imagesList"></tbody>
            </table>
            <div id="paginationControls" class="pagination-controls"></div>`;

        const imagesList = section.querySelector('#imagesList');
        imagesList.innerHTML = `<tr><td colspan="8">加载中...</td></tr>`;

        const data = await (await fetchWithAuth(`/api/images?page=${page}&pageSize=10&keyword=${encodeURIComponent(keyword)}`)).json();
        
        // --- 新增：在重新渲染后，将光标聚焦到输入框末尾 ---
        const keywordInput = document.getElementById('imageSearchInput');
        keywordInput.focus();
        keywordInput.selectionStart = keywordInput.selectionEnd = keywordInput.value.length;
        // --- 新增结束 ---
        
        imagesList.innerHTML = '';
        if (!data.images || data.images.length === 0) {
            imagesList.innerHTML = `<tr><td colspan="8">暂无图片</td></tr>`;
            renderPagination(0, page, 10, keyword); // 传递keyword
            return;
        }
        data.images.forEach(image => {
            const tr = document.createElement('tr');
            const isActive = image.StorageLocations?.some(loc => loc.IsActive);
            const statusBadge = `<span class="status-badge status-${isActive ? 'active' : 'failed'}">${isActive ? '正常' : '失效'}</span>`;
            const dimensions = (image.Width > 0 && image.Height > 0) ? `${image.Width}x${image.Height}` : 'N/A';
            const randomIcon = image.AllowRandom ? `<svg class="random-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>` : '';

            tr.innerHTML = `
                <td><input type="checkbox" class="image-checkbox" data-uuid="${image.UUID}" onchange="updateSelection()"></td>
                <td><img src="/image/${image.UUID}.jpg" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"></td>
                <td>${image.OriginalFilename || 'N/A'}${randomIcon}</td>
                <td>${dimensions}</td>
                <td>${formatSize(image.FileSize)}</td>
                <td>${new Date(image.CreatedAt).toLocaleString()}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="window.open('/admin/images/${image.UUID}', '_blank')">查看</button>
                    <button class="btn btn-primary btn-small" onclick="copyLink('${window.location.origin}/image/${image.UUID}.jpg')">复制</button>
                    <button class="btn btn-danger btn-small" onclick="deleteImage('${image.UUID}')">删除</button>
                </td>`;
            tr.querySelector('.image-checkbox').checked = selectedImages.has(image.UUID);
            imagesList.appendChild(tr);
        });
        renderPagination(data.total, data.page, data.pageSize, keyword); // 传递keyword
        updateSelection();
    }
    
    // searchImages 函数修改
    function searchImages() {
        const keywordInput = document.getElementById('imageSearchInput');
        const keyword = keywordInput ? keywordInput.value.trim() : '';
        loadImages(1, keyword); // 将读取到的 keyword 传递进去
    }

    // goToPage 函数修改
    function goToPage(totalPages, keyword = '') { // 增加 keyword 参数
        const input = document.getElementById('pageInput');
        if (!input) return;
        const page = parseInt(input.value);
        if (!isNaN(page) && page > 0 && page <= totalPages) {
            loadImages(page, keyword); // 传递 keyword
        } else {
            beautifulAlert.alert(`请输入一个 1 到 ${totalPages} 之间的有效页码。`, 'warning');
            input.value = '';
        }
    }

    // renderPagination 函数修改
    function renderPagination(total, page, pageSize, keyword = '') { // 增加 keyword 参数
        const controls = document.getElementById('paginationControls');
        if (!controls) return;
        
        const totalPages = Math.ceil(total / pageSize);
        if (totalPages <= 1) {
            controls.innerHTML = '';
            return;
        }

        let pageControlsHtml = '<div class="pagination-pages">';
        const maxVisiblePages = 5;
        let startPage, endPage;

        if (totalPages <= maxVisiblePages + 2) {
            startPage = 1;
            endPage = totalPages;
        } else {
            const maxPagesBeforeCurrent = Math.floor(maxVisiblePages / 2);
            const maxPagesAfterCurrent = Math.ceil(maxVisiblePages / 2) - 1;
            if (page <= maxPagesBeforeCurrent + 1) {
                startPage = 1;
                endPage = maxVisiblePages;
            } else if (page + maxPagesAfterCurrent >= totalPages) {
                startPage = totalPages - maxVisiblePages + 1;
                endPage = totalPages;
            } else {
                startPage = page - maxPagesBeforeCurrent;
                endPage = page + maxPagesAfterCurrent;
            }
        }
        
        pageControlsHtml += `<button class="btn btn-secondary" onclick="loadImages(1, '${keyword}')" ${page === 1 ? 'disabled' : ''}>« 首页</button>`;
        pageControlsHtml += `<button class="btn btn-secondary" onclick="loadImages(${page - 1}, '${keyword}')" ${page === 1 ? 'disabled' : ''}>‹ 上一页</button>`;
        
        if (startPage > 1) {
            pageControlsHtml += `<span class="pagination-ellipsis">...</span>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            pageControlsHtml += `<button class="btn ${i === page ? 'btn-primary' : 'btn-secondary'}" onclick="loadImages(${i}, '${keyword}')">${i}</button>`;
        }

        if (endPage < totalPages) {
            pageControlsHtml += `<span class="pagination-ellipsis">...</span>`;
        }
        
        pageControlsHtml += `<button class="btn btn-secondary" onclick="loadImages(${page + 1}, '${keyword}')" ${page === totalPages ? 'disabled' : ''}>下一页 ›</button>`;
        pageControlsHtml += `<button class="btn btn-secondary" onclick="loadImages(${totalPages}, '${keyword}')" ${page === totalPages ? 'disabled' : ''}>末页 »</button>`;
        
        pageControlsHtml += `
            <div class="pagination-jump" style="margin-left: 16px;">
                <input type="number" id="pageInput" class="form-control" style="width: 80px; height: 40px; text-align: center;" min="1" max="${totalPages}" placeholder="页码" onkeydown="if(event.key==='Enter') goToPage(${totalPages}, '${keyword}')">
                <button class="btn btn-primary" style="height: 40px;" onclick="goToPage(${totalPages}, '${keyword}')">跳转</button>
            </div>
        `;

        pageControlsHtml += '</div>';

        const startItem = (page - 1) * pageSize + 1;
        const endItem = Math.min(page * pageSize, total);
        const infoHtml = `<div class="pagination-info">显示 ${startItem} - ${endItem} / 共 ${total} 条</div>`;

        controls.innerHTML = pageControlsHtml + infoHtml;
    }
    
    async function handleBatchSetRandom(isAdding) {
        if (selectedImages.size === 0) {
            beautifulAlert.alert("请至少选择一张图片。", "warning");
            return;
        }
        const actionText = isAdding ? '加入' : '移除';
        const confirmed = await beautifulAlert.confirm(`确定将选中的 ${selectedImages.size} 张图片${actionText}随机图库吗?`);
        if (!confirmed) return;

        const action = isAdding ? 'add_to_random' : 'remove_from_random';
        const res = await fetchWithAuth('/api/admin/images/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: action,
                image_uuids: Array.from(selectedImages)
            })
        });
        
        if (res.ok) {
            beautifulAlert.toast(`批量${actionText}成功!`, 'success');
            selectedImages.clear();
            loadImages(currentPage);
        } else {
            const err = await res.json();
            beautifulAlert.alert(`批量${actionText}失败: ` + (err.error || '未知错误'), 'error');
        }
    }

    async function loadTasks() {
        const section = document.getElementById('tasks');
        section.innerHTML = `<h3>进行中的批量任务</h3>
            <table>
                <thead><tr><th>任务ID</th><th>类型</th><th>状态</th><th>进度</th><th>创建时间</th></tr></thead>
                <tbody id="tasksList"><tr><td colspan="5">加载中...</td></tr></tbody>
            </table>`;
        const res = await fetchWithAuth('/api/admin/tasks');
        const tasks = res.ok ? await res.json() : [];
        const tasksList = document.getElementById('tasksList');
        tasksList.innerHTML = '';
        if (tasks && tasks.length > 0) {
            tasks.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            tasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${task.id.substring(0,8)}...</td><td>${task.type}</td><td>${task.status}</td><td>${task.progress}/${task.total}</td><td>${new Date(task.created_at).toLocaleString()}</td>`;
                tasksList.appendChild(tr);
            });
        } else {
            tasksList.innerHTML = '<tr><td colspan="5">暂无任务</td></tr>';
        }
    }
    
    async function loadBackends() {
        const section = document.getElementById('backends');
        section.innerHTML = `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showAddBackendModal()">添加后端</button>
            </div>
            <table>
                <thead><tr><th>名称</th><th>类型</th><th>优先级</th><th>允许上传</th><th>允许跳转</th><th>创建时间</th><th>操作</th></tr></thead>
                <tbody id="backendsList"></tbody>
            </table>`;
        
        const backends = await (await fetchWithAuth('/api/admin/backends/all')).json();
        const backendsList = section.querySelector('#backendsList');
        backendsList.innerHTML = '';
        backends.forEach(backend => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${backend.Name}</td>
                <td>${backend.Type}</td>
                <td>${backend.Priority}</td>
                <td><span class="status-badge status-${backend.AllowUpload ? 'active' : 'failed'}">${backend.AllowUpload ? '启用' : '禁用'}</span></td>
                <td><span class="status-badge status-${backend.AllowRedirect ? 'active' : 'failed'}">${backend.AllowRedirect ? '启用' : '禁用'}</span></td>
                <td>${new Date(backend.CreatedAt).toLocaleString()}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="showAddBackendModal(${backend.ID})">编辑</button>
                    <button class="btn btn-small ${backend.AllowUpload ? 'btn-danger' : 'btn-success'}" onclick="toggleBackend(${backend.ID}, 'upload')">${backend.AllowUpload ? '禁用上传' : '启用上传'}</button>
                    <button class="btn btn-small ${backend.AllowRedirect ? 'btn-danger' : 'btn-success'}" onclick="toggleBackend(${backend.ID}, 'redirect')">${backend.AllowRedirect ? '禁用跳转' : '启用跳转'}</button>
                    <button class="btn btn-danger btn-small" onclick="deleteBackend(${backend.ID})">删除</button>
                </td>`;
            backendsList.appendChild(tr);
        });
    }
    async function loadSettings() {
        const section = document.getElementById('settings');
        section.innerHTML = '加载中...';
        const settings = await (await fetchWithAuth('/api/settings')).json();
        section.innerHTML = `
            <div class="form-group">
                <label class="form-label">访问策略</label>
                <select id="settingAccessPolicy" class="form-control" style="width: 300px;"><option value="random">随机</option><option value="priority">优先级</option></select>
            </div>
            <div class="form-group">
                <label class="form-label">失败重试次数</label>
                <input id="settingRetryCount" type="number" class="form-control" style="width: 300px;">
                <small style="color: var(--text-secondary); margin-top: 4px; display: block;">设置为 0 代表无限次重试，链接永不因失败而失效。</small>
            </div>
            <div class="form-group">
                <label class="form-label">最大上传(MB)</label>
                <input id="settingMaxUpload" type="number" class="form-control" style="width: 300px;">
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">保存设置</button>`;
        
        document.getElementById('settingAccessPolicy').value = settings.access_policy;
        document.getElementById('settingRetryCount').value = settings.retry_count;
        document.getElementById('settingMaxUpload').value = settings.max_upload_mb;
    }
    
    async function loadUsers() {
        const section = document.getElementById('users');
        if (userRole === 'admin') {
            section.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showAddUserModal()">添加用户</button>
                    <button class="btn btn-primary" onclick="showChangePasswordModal()">修改我的密码</button>
                </div>
                <table>
                    <thead><tr><th>ID</th><th>用户名</th><th>角色</th><th>创建时间</th><th>操作</th></tr></thead>
                    <tbody id="usersList"></tbody>
                </table>
                <h3 style="margin-top: 30px; margin-bottom: 15px;">我的API Token</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showCreateAPITokenModal()">创建新Token</button>
                </div>
                <table>
                    <thead><tr><th>名称</th><th>Token值</th><th>状态</th><th>创建时间</th><th>操作</th></tr></thead>
                    <tbody id="apiTokensList"></tbody>
                </table>`;
            
            const users = await (await fetchWithAuth('/api/admin/users')).json();
            const usersList = section.querySelector('#usersList');
            usersList.innerHTML = '';
            const currentUserID = parseInt(localStorage.getItem('user_id'));
            users.forEach(user => {
                const tr = document.createElement('tr');
                let actions = `<button class="btn btn-primary btn-small" onclick="resetUserPassword(${user.ID})">重置密码</button>`;
                if (user.ID !== currentUserID) {
                    actions += ` <button class="btn btn-danger btn-small" onclick="deleteUser(${user.ID})">删除</button>`;
                }
                tr.innerHTML = `<td>${user.ID}</td><td>${user.Username}</td><td>${user.Role}</td><td>${new Date(user.CreatedAt).toLocaleString()}</td><td>${actions}</td>`;
                usersList.appendChild(tr);
            });
        } else {
            // User view
            section.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="showChangePasswordModal()">修改我的密码</button>
                </div>
                <h3 style="margin-top: 30px; margin-bottom: 15px;">我的API Token</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showCreateAPITokenModal()">创建新Token</button>
                </div>
                <table>
                    <thead><tr><th>名称</th><th>Token值</th><th>状态</th><th>创建时间</th><th>操作</th></tr></thead>
                    <tbody id="apiTokensList"></tbody>
                </table>`;
        }
        loadAPITokens();
    }
    

    function toggleSelectAll(checked) {
        document.querySelectorAll('.image-checkbox').forEach(cb => cb.checked = checked);
        updateSelection();
    }
    function updateSelection() {
        document.querySelectorAll('.image-checkbox').forEach(cb => {
            if (cb.checked) selectedImages.add(cb.dataset.uuid);
            else selectedImages.delete(cb.dataset.uuid);
        });
        const countSpan = document.getElementById('selectionCount');
        if (countSpan) countSpan.textContent = selectedImages.size;
        const allPageCheckboxes = document.querySelectorAll('.image-checkbox');
        const allPageSelected = allPageCheckboxes.length > 0 && Array.from(allPageCheckboxes).every(cb => cb.checked);
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) selectAllCheckbox.checked = allPageSelected;
    }

    async function handleBatchDelete() {
        if (selectedImages.size === 0) { beautifulAlert.alert("请至少选择一张图片。", 'warning'); return; }
        const confirmed = await beautifulAlert.confirm(`确定删除选中的 ${selectedImages.size} 张图片吗?`);
        if (!confirmed) return;
        const endpoint = userRole === 'admin' ? '/api/admin/images/batch' : '/api/images/batch';
        const res = await fetchWithAuth(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', image_uuids: Array.from(selectedImages) })
        });
        if (res.ok) {
            beautifulAlert.toast('批量删除任务已开始','success');
            selectedImages.clear();
            loadImages(currentPage);
            if (userRole === 'admin') showSection('tasks');
        } else {
             const err = await res.json();
             beautifulAlert.alert('批量删除失败: ' + (err.error || '未知错误'), 'error');
        }
    }
    async function handleBatchBackfill() {
        if (selectedImages.size === 0) {
            beautifulAlert.alert("请至少选择一张图片。", "warning");
            return;
        }
        
        const backends = await (await fetchWithAuth('/api/backends')).json();
        if (!backends || backends.length === 0) {
            beautifulAlert.alert("没有可用的存储后端。", 'error');
            return;
        }
        const options = backends.map(b => `<option value="${b.ID}">${b.Name} (${b.Type})</option>`).join('');
        showModal('batchBackfillModal', `
            <div class="modal-header"><h2 class="modal-title">批量补传</h2></div>
            <div class="form-group">
                <label>选择要补传到的目标后端:</label>
                <select id="backendSelect" class="form-control">${options}</select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('batchBackfillModal')">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmBackfill()">开始补传</button>
            </div>
        `);
    }
    async function confirmBackfill() {
        const backendId = document.getElementById('backendSelect').value;
        if (!backendId) {
            beautifulAlert.alert("请选择一个后端。", "warning");
            return;
        }
        const endpoint = userRole === 'admin' ? '/api/admin/images/batch' : '/api/images/batch';
        const res = await fetchWithAuth(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'backfill',
                image_uuids: Array.from(selectedImages),
                backend_id: parseInt(backendId)
            })
        });
        if (res.ok) {
            beautifulAlert.toast('批量补传任务已开始。', 'info');
            closeModal('batchBackfillModal');
            selectedImages.clear();
            loadImages(currentPage);
            if (userRole === 'admin') showSection('tasks');
        } else {
            const err = await res.json();
            beautifulAlert.alert('任务开始失败: ' + (err.error || '未知错误'), 'error');
        }
    }
    function copyLink(link) { navigator.clipboard.writeText(link).then(() => beautifulAlert.toast('链接已复制!', 'success')); }
    async function deleteImage(uuid) {
        const confirmed = await beautifulAlert.confirm('确定删除这张图片吗？');
        if (!confirmed) return;
        await fetchWithAuth(`/api/images/${uuid}`, { method: 'DELETE' });
        selectedImages.delete(uuid);
        loadImages(currentPage);
    }
    function formatSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
    }
    function logout() { localStorage.clear(); window.location.href = '/login'; }
    
    async function saveSettings() {
        const payload = {
            access_policy: document.getElementById('settingAccessPolicy').value,
            retry_count: document.getElementById('settingRetryCount').value,
            max_upload_mb: document.getElementById('settingMaxUpload').value
        };
        const res = await fetchWithAuth('/api/admin/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) beautifulAlert.toast('设置保存成功!', 'success');
        else beautifulAlert.alert('保存失败!', 'error');
    }
    async function loadAPITokens() {
        const tokens = await (await fetchWithAuth('/api/user/tokens')).json();
        const apiTokensList = document.getElementById('apiTokensList');
        apiTokensList.innerHTML = '';
        if (tokens && tokens.length > 0) {
            tokens.forEach(token => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${token.Name}</td>
                    <td><code>${token.Token}</code></td>
                    <td><span class="status-badge status-${token.IsActive ? 'active' : 'failed'}">${token.IsActive ? '启用' : '禁用'}</span></td>
                    <td>${new Date(token.CreatedAt).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-small ${token.IsActive ? 'btn-danger' : 'btn-success'}" onclick="toggleAPITokenStatus(${token.ID})">${token.IsActive ? '禁用' : '启用'}</button>
                        <button class="btn btn-danger btn-small" onclick="deleteAPIToken(${token.ID})">删除</button>
                    </td>`;
                apiTokensList.appendChild(tr);
            });
        } else {
            apiTokensList.innerHTML = '<tr><td colspan="5">暂无API Token</td></tr>';
        }
    }
    
    async function deleteBackend(id) {
        const confirmed = await beautifulAlert.confirm('确定删除此后端吗?');
        if(!confirmed) return;
        const res = await fetchWithAuth(`/api/admin/backends/${id}`, {method: 'DELETE'});
        if(!res.ok) {
            const err = await res.json();
            beautifulAlert.alert('删除失败: ' + (err.error || '未知错误'), 'error');
        }
        loadBackends();
    }
    async function toggleBackend(id, flag) {
        if (!flag) {
            console.error("Toggle flag is missing!");
            return;
        }
        await fetchWithAuth(`/api/admin/backends/${id}/toggle/${flag}`, {method: 'POST'});
        loadBackends();
    }
    async function deleteUser(id) {
        const confirmed = await beautifulAlert.confirm('确定删除此用户吗?');
        if(!confirmed) return;
        await fetchWithAuth(`/api/admin/users/${id}`, {method: 'DELETE'});
        loadUsers();
    }
    async function resetUserPassword(id) {
        const newPassword = await beautifulAlert.prompt('请输入新密码:');
        if (!newPassword) return;
        const res = await fetchWithAuth(`/api/admin/users/${id}/reset-password`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password: newPassword})
        });
        if (res.ok) beautifulAlert.toast('密码重置成功!', 'success');
        else beautifulAlert.alert('重置失败!', 'error');
    }
    async function deleteAPIToken(id) {
        const confirmed = await beautifulAlert.confirm('确定删除此Token吗?');
        if(!confirmed) return;
        await fetchWithAuth(`/api/user/tokens/${id}`, {method: 'DELETE'});
        loadAPITokens();
    }
    async function toggleAPITokenStatus(id) {
        await fetchWithAuth(`/api/user/tokens/${id}/toggle`, {method: 'POST'});
        loadAPITokens();
    }
    
    function closeModal(modalId) { 
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            modal.innerHTML = ''; 
        }
    }
    async function showModal(id, content) {
        const modal = document.getElementById(id);
        if (!modal) return;
        
        modal.innerHTML = `<div class="modal-content">${content}</div>`;
        modal.classList.add('active');
        
        const form = modal.querySelector('form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                try {
                    const formData = new FormData(e.target);
                    const payload = Object.fromEntries(formData.entries());
                    
                    let url = e.target.action;
                    let method = e.target.method;
                    
                    if (id === 'addBackendModal' && currentEditingBackendId) {
                        url = `/api/admin/backends/${currentEditingBackendId}`;
                        method = 'PUT';
                    }
                    
                    if (id === 'addBackendModal') {
                        const config = {};
                        modal.querySelectorAll('#configFields .form-control').forEach(input => {
                            config[input.name] = input.value;
                        });
                        
                        payload.Name = payload.name;
                        payload.Type = payload.type;
                        payload.Priority = parseInt(payload.priority || 1);
                        payload.Config = config;
                        
                        delete payload.name;
                        delete payload.type;
                        delete payload.priority;
                    }
                    
                    const res = await fetchWithAuth(url, {
                        method: method.toUpperCase(),
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (res.ok) {
                        beautifulAlert.toast('操作成功!', 'success');
                        closeModal(id);
                        
                        if (id === 'addUserModal' || id === 'changePasswordModal') loadUsers();
                        if (id === 'createAPITokenModal') loadAPITokens();
                        if (id === 'addBackendModal') loadBackends();
                    } else {
                        const err = await res.json();
                        beautifulAlert.alert('操作失败: ' + (err.error || '未知服务器错误'), 'error');
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    beautifulAlert.alert('请求发送失败，请检查网络连接。', 'error');
                }
            });
        }
    }
    function showAddUserModal() {
        showModal('addUserModal', `
            <div class="modal-header"><h2 class="modal-title">添加用户</h2></div>
            <form action="/api/admin/users" method="post">
                <div class="form-group"><label>用户名</label><input type="text" class="form-control" name="username" required></div>
                <div class="form-group"><label>密码</label><input type="password" class="form-control" name="password" required></div>
                <div class="form-group"><label>角色</label><select class="form-control" name="role"><option value="user">用户</option><option value="admin">管理员</option></select></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('addUserModal')">取消</button><button type="submit" class="btn btn-primary">添加</button></div>
            </form>`);
    }
    function showChangePasswordModal() {
        showModal('changePasswordModal', `
            <div class="modal-header"><h2 class="modal-title">修改我的密码</h2></div>
            <form action="/api/user/change-password" method="post">
                <div class="form-group"><label>旧密码</label><input type="password" class="form-control" name="old_password" required></div>
                <div class="form-group"><label>新密码</label><input type="password" class="form-control" name="new_password" required></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('changePasswordModal')">取消</button><button type="submit" class="btn btn-primary">修改</button></div>
            </form>`);
    }
    function showCreateAPITokenModal() {
        showModal('createAPITokenModal', `
            <div class="modal-header"><h2 class="modal-title">创建API Token</h2></div>
            <form action="/api/user/tokens" method="post">
                <div class="form-group"><label>Token名称</label><input type="text" class="form-control" name="name" required></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('createAPITokenModal')">取消</button><button type="submit" class="btn btn-primary">创建</button></div>
            </form>`);
    }
    async function showAddBackendModal(id = null) {
        currentEditingBackendId = id;
        
        const isEditMode = id !== null;
        const typeSelectDisabled = isEditMode ? 'disabled' : '';

        let content = `
            <div class="modal-header"><h2 class="modal-title">${isEditMode ? '编辑' : '添加'}后端</h2></div>
            <form action="/api/admin/backends" method="post">
                <div class="form-group"><label>名称</label><input type="text" class="form-control" name="name" required></div>
                <div class="form-group"><label>类型</label><select class="form-control" name="type" onchange="updateConfigFields(this.value)" ${typeSelectDisabled}><option value="local">本地</option><option value="sm.ms">SM.MS</option><option value="oss">阿里云OSS</option></select></div>
                <div class="form-group"><label>优先级</label><input type="number" class="form-control" name="priority" value="1" required></div>
                <div id="configFields"></div>
                <div id="smmsValidationArea" style="display: none; margin-top: 15px; text-align: right;">
                    <button type="button" class="btn btn-primary" onclick="validateSmmsConnection()">验证连接</button>
                    <span id="smmsValidationResult" style="margin-left: 10px;"></span>
                </div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('addBackendModal')">取消</button><button type="submit" class="btn btn-primary">保存</button></div>
            </form>`;
        
        await showModal('addBackendModal', content);
        
        if (isEditMode) {
            const backends = await (await fetchWithAuth('/api/admin/backends/all')).json();
            const backend = backends.find(b => b.ID === id);
            if (backend) {
                const modal = document.getElementById('addBackendModal');
                modal.querySelector('[name="name"]').value = backend.Name;
                modal.querySelector('[name="type"]').value = backend.Type;
                modal.querySelector('[name="priority"]').value = backend.Priority;
                
                // 确保 config 是一个对象，然后更新字段
                const configObject = (typeof backend.Config === 'string') ? JSON.parse(backend.Config) : backend.Config;
                updateConfigFields(backend.Type, configObject || {});
            }
        } else {
            // 对于新后端，默认显示 local 的配置
            updateConfigFields('local', {});
        }
    }
    function updateConfigFields(type, config = {}) {
        const container = document.getElementById('configFields');
        const smmsArea = document.getElementById('smmsValidationArea');
        smmsArea.style.display = 'none';

        const isEditMode = currentEditingBackendId !== null;

        if (type === 'local') {
            const storagePathReadonly = isEditMode ? 'readonly' : '';
            const helpText = isEditMode ? '<small style="color: var(--text-secondary); margin-top: 4px; display: block;">存储路径在创建后不可修改。</small>' : '';
            container.innerHTML = `
                <div class="form-group">
                    <label>存储路径</label>
                    <input class="form-control" name="storagePath" value="${config.storagePath || 'uploads'}" ${storagePathReadonly}>
                    ${helpText}
                </div>
                <div class="form-group"><label>访问URL前缀</label><input class="form-control" name="publicUrl" value="${config.publicUrl || 'http://127.0.0.1:3030'}"></div>`;
        } else if (type === 'sm.ms') {
            smmsArea.style.display = 'block';
            container.innerHTML = `
                <div class="form-group"><label>API URL</label><input class="form-control" name="baseURL" value="${config.baseURL || 'https://smms.app/api/v2/'}"></div>
                <div class="form-group"><label>API Token</label><input type="password" class="form-control" name="token" value="${config.token || ''}"></div>`;
        } else if (type === 'oss') {
            container.innerHTML = `
                <div class="form-group"><label>Endpoint</label><input class="form-control" name="endpoint" placeholder="例如: oss-cn-hangzhou.aliyuncs.com" value="${config.endpoint || ''}"></div>
                <div class="form-group"><label>Bucket 名称</label><input class="form-control" name="bucket" value="${config.bucket || ''}"></div>
                <div class="form-group"><label>AccessKey ID</label><input class="form-control" name="accessKeyId" value="${config.accessKeyId || ''}"></div>
                <div class="form-group"><label>AccessKey Secret</label><input type="password" class="form-control" name="accessKeySecret" value="${config.accessKeySecret || ''}"></div>
                <div class="form-group"><label>自定义域名 (可选)</label><input class="form-control" name="publicUrl" placeholder="例如: https://img.yourdomain.com" value="${config.publicUrl || ''}"></div>
                <div class="form-group"><label>存储路径前缀 (可选)</label><input class="form-control" name="uploadPath" placeholder="例如: images/2025" value="${config.uploadPath || ''}"></div>`;
        }
    }
    async function validateSmmsConnection() {
        const modal = document.getElementById('addBackendModal');
        const baseURL = modal.querySelector('[name="baseURL"]').value;
        const token = modal.querySelector('[name="token"]').value;
        const resultSpan = document.getElementById('smmsValidationResult');
        resultSpan.textContent = '验证中...';
        const res = await fetchWithAuth('/api/admin/backends/smms/validate-token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ baseURL, token })
        });
        const result = await res.json();
        resultSpan.textContent = result.message;
        resultSpan.style.color = result.success ? 'green' : 'red';
    }
    </script>
</body>
</html>

