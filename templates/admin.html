<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›é™å›¾åºŠ - åå°ç®¡ç†</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <script src="static/js/toast.js" defer></script>
    <script>
        function checkAuth() {
            if (!localStorage.getItem('jwt_token')) {
                localStorage.setItem('redirect_after_login', window.location.pathname);
                window.location.href = '/login';
            }
        }
        checkAuth();
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            options = options || {};
            options.headers = options.headers || {};
            const token = localStorage.getItem('jwt_token');
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
            return new Promise((resolve, reject) => {
                originalFetch(url, options).then(response => {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.clear();
                        window.location.href = '/login';
                        reject(new Error('Authentication Failed'));
                        return;
                    }
                    resolve(response);
                }).catch(error => {
                    reject(error);
                });
            });
        };
    </script>
</head>
<body>
    <script>document.body.classList.add('js-loading');</script>
    <div class="container">
        <div class="header">
            <h1>å›¾åºŠç®¡ç†åå°</h1>
            <div class="header-actions">
                <a href="/" target="_blank">ğŸ“· è¿”å›ä¸»é¡µ</a>
                <a href="#" onclick="logout()">ğŸšª é€€å‡ºç™»å½•</a>
            </div>
        </div>
        <div class="tabs">
            <button class="tab" onclick="showSection('overview')">ğŸ“Š æ¦‚è§ˆ</button>
            <button class="tab" onclick="showSection('images')">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</button>
            <button class="tab" onclick="showSection('tasks')">âš™ï¸ æ‰¹é‡ä»»åŠ¡</button>
            <button class="tab" onclick="showSection('backends')">ğŸ’¾ å­˜å‚¨åç«¯</button>
            <button class="tab" onclick="showSection('settings')">âš¡ ç³»ç»Ÿè®¾ç½®</button>
            <button class="tab" onclick="showSection('users')">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</button>
        </div>
        <div class="content">
            <div id="overview" class="section"></div>
            <div id="images" class="section"></div>
            <div id="tasks" class="section"></div>
            <div id="backends" class="section"></div>
            <div id="settings" class="section"></div>
            <div id="users" class="section"></div>
        </div>
    </div>
    <div class="modal" id="addBackendModal"></div>
    <div class="modal" id="addUserModal"></div>
    <div class="modal" id="changePasswordModal"></div>
    <div class="modal" id="createAPITokenModal"></div>
    <div class="modal" id="batchBackfillModal"></div>
    
    <script>
    // [JavaScriptä»£ç ä¿æŒä¸å˜ï¼Œä¸åŸæ–‡ä»¶ç›¸åŒ]
    let currentPage = 1;
    let selectedImages = new Set();
    let currentEditingBackendId = null;
    
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const userInfoRes = await fetch('/api/user/info');
            if (userInfoRes.ok) {
                const userInfo = await userInfoRes.json();
                localStorage.setItem('user_id', userInfo.user_id);
                localStorage.setItem('user_role', userInfo.role);
            } else {
                logout();
                return;
            }
            const lastTab = localStorage.getItem('activeAdminTab') || 'overview';
            showSection(lastTab);
        } catch (error) {
            console.error("Initialization failed:", error);
            logout();
        } finally {
            document.body.classList.remove('js-loading');
        }
    });
    
    function showSection(sectionId) {
        localStorage.setItem('activeAdminTab', sectionId);
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const tabButton = document.querySelector(`.tab[onclick="showSection('${sectionId}')"]`);
        if (tabButton) tabButton.classList.add('active');
        const section = document.getElementById(sectionId);
        if (section) {
            section.classList.add('active');
            switch (sectionId) {
                case 'overview': loadOverview(); break;
                case 'images': loadImages(1); break;
                case 'tasks': loadTasks(); break;
                case 'backends': loadBackends(); break;
                case 'settings': loadSettings(); break;
                case 'users': loadUsers(); break;
            }
        }
    }
    
    async function loadOverview() {
        const section = document.getElementById('overview');
        section.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="totalImages">...</div><div class="stat-label">æ€»å›¾ç‰‡æ•°</div></div>
                <div class="stat-card"><div class="stat-value" id="totalSize">...</div><div class="stat-label">æ€»å ç”¨ç©ºé—´</div></div>
                <div class="stat-card"><div class="stat-value" id="totalBackends">...</div><div class="stat-label">å­˜å‚¨åç«¯</div></div>
                <div class="stat-card"><div class="stat-value" id="todayUploads">...</div><div class="stat-label">ä»Šæ—¥ä¸Šä¼ </div></div>
            </div>
            <h3 style="margin-bottom: 15px;">æœ€è¿‘ä¸Šä¼ </h3>
            <div class="image-grid" id="recentImages">åŠ è½½ä¸­...</div>`;
        const stats = await (await fetch('/api/stats')).json();
        document.getElementById('totalImages').textContent = stats.totalImages;
        document.getElementById('totalSize').textContent = formatSize(stats.totalSize);
        document.getElementById('totalBackends').textContent = stats.totalBackends;
        document.getElementById('todayUploads').textContent = stats.todayUploads;
        const recentData = await (await fetch('/api/images/recent')).json();
        const recentGrid = document.getElementById('recentImages');
        recentGrid.innerHTML = '';
        if (recentData && recentData.length > 0) {
            recentData.forEach(img => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.innerHTML = `<img src="/i/${img.UUID}" alt="${img.OriginalFilename}"><div class="image-info">${img.OriginalFilename}</div>`;
                recentGrid.appendChild(item);
            });
        } else {
            recentGrid.innerHTML = '<p>æš‚æ— å›¾ç‰‡</p>';
        }
    }
    
    async function loadImages(page = 1) {
        currentPage = page;
        const section = document.getElementById('images');
        
        const imagesList = section.querySelector('#imagesList');
        const keywordInput = section.querySelector('#imageSearchInput');
        if (!imagesList) {
            section.innerHTML = `
                <div id="batchActionBar" style="margin-bottom: 15px;">
                    <span>å·²é€‰ä¸­ <strong id="selectionCount">0</strong> å¼ å›¾ç‰‡</span>
                    <button class="btn btn-danger" onclick="handleBatchDelete()">æ‰¹é‡åˆ é™¤</button>
                    <button class="btn btn-primary" onclick="handleBatchBackfill()">æ‰¹é‡è¡¥ä¼ </button>
                </div>
                <div style="margin-bottom: 15px;">
                    <input id="imageSearchInput" type="text" placeholder="æœç´¢å›¾ç‰‡..." style="width: 300px; display: inline-block;">
                    <button class="btn btn-primary" onclick="searchImages()">æœç´¢</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"></th>
                            <th>é¢„è§ˆ</th><th>æ–‡ä»¶å</th><th>å°ºå¯¸</th><th>å¤§å°</th><th>ä¸Šä¼ æ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="imagesList"></tbody>
                </table>
                <div id="paginationControls" class="pagination-controls"></div>`;
            loadImages(page);
            return;
        }
        const keyword = keywordInput ? keywordInput.value.trim() : '';
        imagesList.innerHTML = `<tr><td colspan="8">åŠ è½½ä¸­...</td></tr>`;
        const data = await (await fetch(`/api/images?page=${page}&pageSize=10&keyword=${encodeURIComponent(keyword)}`)).json();
        
        imagesList.innerHTML = '';
        if (!data.images || data.images.length === 0) {
            imagesList.innerHTML = `<tr><td colspan="8">æš‚æ— å›¾ç‰‡</td></tr>`;
            renderPagination(0, page, 10);
            return;
        }
        data.images.forEach(image => {
            const tr = document.createElement('tr');
            const isActive = image.StorageLocations?.some(loc => loc.IsActive);
            const statusBadge = `<span class="status-badge status-${isActive ? 'active' : 'failed'}">${isActive ? 'æ­£å¸¸' : 'å¤±æ•ˆ'}</span>`;
            const dimensions = (image.Width > 0 && image.Height > 0) ? `${image.Width}x${image.Height}` : 'N/A';
            tr.innerHTML = `
                <td><input type="checkbox" class="image-checkbox" data-uuid="${image.UUID}" onchange="updateSelection()"></td>
                <td><img src="/i/${image.UUID}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"></td>
                <td>${image.OriginalFilename || 'N/A'}</td>
                <td>${dimensions}</td>
                <td>${formatSize(image.FileSize)}</td>
                <td>${new Date(image.CreatedAt).toLocaleString()}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="window.open('/admin/images/${image.UUID}', '_blank')">æŸ¥çœ‹</button>
                    <button class="btn btn-primary btn-small" onclick="copyLink('${window.location.origin}/i/${image.UUID}')">å¤åˆ¶</button>
                    <button class="btn btn-danger btn-small" onclick="deleteImage('${image.UUID}')">åˆ é™¤</button>
                </td>`;
            tr.querySelector('.image-checkbox').checked = selectedImages.has(image.UUID);
            imagesList.appendChild(tr);
        });
        renderPagination(data.total, data.page, data.pageSize);
        updateSelection();
    }
    
    async function loadTasks() {
        const section = document.getElementById('tasks');
        section.innerHTML = `<h3>è¿›è¡Œä¸­çš„æ‰¹é‡ä»»åŠ¡</h3>
            <table>
                <thead><tr><th>ä»»åŠ¡ID</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>è¿›åº¦</th><th>åˆ›å»ºæ—¶é—´</th></tr></thead>
                <tbody id="tasksList"><tr><td colspan="5">åŠ è½½ä¸­...</td></tr></tbody>
            </table>`;
        const res = await fetch('/api/admin/tasks');
        const tasks = res.ok ? await res.json() : [];
        const tasksList = document.getElementById('tasksList');
        tasksList.innerHTML = '';
        if (tasks && tasks.length > 0) {
            tasks.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            tasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${task.id.substring(0,8)}...</td><td>${task.type}</td><td>${task.status}</td><td>${task.progress}/${task.total}</td><td>${new Date(task.created_at).toLocaleString()}</td>`;
                tasksList.appendChild(tr);
            });
        } else {
            tasksList.innerHTML = '<tr><td colspan="5">æš‚æ— ä»»åŠ¡</td></tr>';
        }
    }
    
    async function loadBackends() {
        const section = document.getElementById('backends');
        section.innerHTML = `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showAddBackendModal()">æ·»åŠ åç«¯</button>
            </div>
            <table>
                <thead><tr><th>åç§°</th><th>ç±»å‹</th><th>ä¼˜å…ˆçº§</th><th>å…è®¸ä¸Šä¼ </th><th>å…è®¸è·³è½¬</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="backendsList"></tbody>
            </table>`;
        
        const backends = await (await fetch('/api/admin/backends/all')).json();
        const backendsList = section.querySelector('#backendsList');
        backendsList.innerHTML = '';
        backends.forEach(backend => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${backend.Name}</td>
                <td>${backend.Type}</td>
                <td>${backend.Priority}</td>
                <td><span class="status-badge status-${backend.AllowUpload ? 'active' : 'failed'}">${backend.AllowUpload ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                <td><span class="status-badge status-${backend.AllowRedirect ? 'active' : 'failed'}">${backend.AllowRedirect ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                <td>${new Date(backend.CreatedAt).toLocaleString()}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="showAddBackendModal(${backend.ID})">ç¼–è¾‘</button>
                    <button class="btn btn-small ${backend.AllowUpload ? 'btn-danger' : 'btn-success'}" onclick="toggleBackend(${backend.ID}, 'upload')">${backend.AllowUpload ? 'ç¦ç”¨ä¸Šä¼ ' : 'å¯ç”¨ä¸Šä¼ '}</button>
                    <button class="btn btn-small ${backend.AllowRedirect ? 'btn-danger' : 'btn-success'}" onclick="toggleBackend(${backend.ID}, 'redirect')">${backend.AllowRedirect ? 'ç¦ç”¨è·³è½¬' : 'å¯ç”¨è·³è½¬'}</button>
                    <button class="btn btn-danger btn-small" onclick="deleteBackend(${backend.ID})">åˆ é™¤</button>
                </td>`;
            backendsList.appendChild(tr);
        });
    }
    async function loadSettings() {
        const section = document.getElementById('settings');
        section.innerHTML = 'åŠ è½½ä¸­...';
        const settings = await (await fetch('/api/settings')).json();
        section.innerHTML = `
            <div class="form-group">
                <label class="form-label">è®¿é—®ç­–ç•¥</label>
                <select id="settingAccessPolicy" class="form-control" style="width: 300px;"><option value="random">éšæœº</option><option value="priority">ä¼˜å…ˆçº§</option></select>
            </div>
            <div class="form-group">
                <label class="form-label">å¤±è´¥é‡è¯•æ¬¡æ•°</label>
                <input id="settingRetryCount" type="number" class="form-control" style="width: 300px;">
            </div>
            <div class="form-group">
                <label class="form-label">æœ€å¤§ä¸Šä¼ (MB)</label>
                <input id="settingMaxUpload" type="number" class="form-control" style="width: 300px;">
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>`;
        
        document.getElementById('settingAccessPolicy').value = settings.access_policy;
        document.getElementById('settingRetryCount').value = settings.retry_count;
        document.getElementById('settingMaxUpload').value = settings.max_upload_mb;
    }
    async function loadUsers() {
        const section = document.getElementById('users');
        section.innerHTML = `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showAddUserModal()">æ·»åŠ ç”¨æˆ·</button>
                <button class="btn btn-primary" onclick="showChangePasswordModal()">ä¿®æ”¹æˆ‘çš„å¯†ç </button>
            </div>
            <table>
                <thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>è§’è‰²</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="usersList"></tbody>
            </table>
            <h3 style="margin-top: 30px; margin-bottom: 15px;">æˆ‘çš„API Token</h3>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showCreateAPITokenModal()">åˆ›å»ºæ–°Token</button>
            </div>
            <table>
                <thead><tr><th>åç§°</th><th>Tokenå€¼</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="apiTokensList"></tbody>
            </table>`;
        
        const users = await (await fetch('/api/admin/users')).json();
        const usersList = section.querySelector('#usersList');
        usersList.innerHTML = '';
        const currentUserID = parseInt(localStorage.getItem('user_id'));
        users.forEach(user => {
            const tr = document.createElement('tr');
            let actions = `<button class="btn btn-primary btn-small" onclick="resetUserPassword(${user.ID})">é‡ç½®å¯†ç </button>`;
            if (user.ID !== currentUserID) {
                actions += ` <button class="btn btn-danger btn-small" onclick="deleteUser(${user.ID})">åˆ é™¤</button>`;
            }
            tr.innerHTML = `<td>${user.ID}</td><td>${user.Username}</td><td>${user.Role}</td><td>${new Date(user.CreatedAt).toLocaleString()}</td><td>${actions}</td>`;
            usersList.appendChild(tr);
        });
        loadAPITokens();
    }
    
    function searchImages() { loadImages(1); }
    function renderPagination(total, page, pageSize) {
        const controls = document.getElementById('paginationControls');
        if (!controls) return;
        controls.innerHTML = '';
        const totalPages = Math.ceil(total / pageSize);
        if (totalPages <= 1) return;
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = `btn ${i === page ? 'btn-primary' : 'btn-secondary'}`;
            btn.onclick = () => loadImages(i);
            controls.appendChild(btn);
        }
    }
    function toggleSelectAll(checked) {
        document.querySelectorAll('.image-checkbox').forEach(cb => cb.checked = checked);
        updateSelection();
    }
    function updateSelection() {
        document.querySelectorAll('.image-checkbox').forEach(cb => {
            if (cb.checked) selectedImages.add(cb.dataset.uuid);
            else selectedImages.delete(cb.dataset.uuid);
        });
        const countSpan = document.getElementById('selectionCount');
        if (countSpan) countSpan.textContent = selectedImages.size;
        const allPageCheckboxes = document.querySelectorAll('.image-checkbox');
        const allPageSelected = allPageCheckboxes.length > 0 && Array.from(allPageCheckboxes).every(cb => cb.checked);
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) selectAllCheckbox.checked = allPageSelected;
    }
    async function handleBatchDelete() {
        if (selectedImages.size === 0) { alert("è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚"); return; }
        if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedImages.size} å¼ å›¾ç‰‡å—?`)) return;
        const res = await fetch('/api/admin/images/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', image_uuids: Array.from(selectedImages) })
        });
        if (res.ok) {
            beautifulAlert.alert('æ‰¹é‡åˆ é™¤ä»»åŠ¡å·²å¼€å§‹','success');
            selectedImages.clear();
            loadImages(currentPage);
            showSection('tasks');
        } else { beautifulAlert.alert('æ‰¹é‡åˆ é™¤å¤±è´¥', 'error'); }
    }
    async function handleBatchBackfill() {
        if (selectedImages.size === 0) {
            beautifulAlert.alert("è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚", "warning");
            return;
        }
        
        const backends = await (await fetch('/api/admin/backends/all')).json();
        if (!backends || backends.length === 0) {
            beautifulAlert.alert("æ²¡æœ‰å¯ç”¨çš„å­˜å‚¨åç«¯ã€‚", 'error');
            return;
        }
        const options = backends.map(b => `<option value="${b.ID}">${b.Name} (${b.Type})</option>`).join('');
        showModal('batchBackfillModal', `
            <div class="modal-header"><h2 class="modal-title">æ‰¹é‡è¡¥ä¼ </h2></div>
            <div class="form-group">
                <label>é€‰æ‹©è¦è¡¥ä¼ åˆ°çš„ç›®æ ‡åç«¯:</label>
                <select id="backendSelect" class="form-control">${options}</select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('batchBackfillModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmBackfill()">å¼€å§‹è¡¥ä¼ </button>
            </div>
        `);
    }
    async function confirmBackfill() {
        const backendId = document.getElementById('backendSelect').value;
        if (!backendId) {
            beautifulAlert.alert("è¯·é€‰æ‹©ä¸€ä¸ªåç«¯ã€‚", "warning");
            return;
        }
        const res = await fetch('/api/admin/images/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'backfill',
                image_uuids: Array.from(selectedImages),
                backend_id: parseInt(backendId)
            })
        });
        if (res.ok) {
            beautifulAlert.alert('æ‰¹é‡è¡¥ä¼ ä»»åŠ¡å·²å¼€å§‹ã€‚', 'info');
            closeModal('batchBackfillModal');
            selectedImages.clear();
            loadImages(currentPage);
            showSection('tasks');
        } else {
            const err = await res.json();
            beautifulAlert.alert('ä»»åŠ¡å¼€å§‹å¤±è´¥: ' + (err.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    }
    function copyLink(link) { navigator.clipboard.writeText(link).then(() => beautifulAlert.toast('é“¾æ¥å·²å¤åˆ¶!', 'success')); }
    async function deleteImage(uuid) {
        if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
        await fetch(`/api/images/${uuid}`, { method: 'DELETE' });
        selectedImages.delete(uuid);
        loadImages(currentPage);
    }
    function formatSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
    }
    function logout() { localStorage.clear(); window.location.href = '/login'; }
    
    async function saveSettings() {
        const payload = {
            access_policy: document.getElementById('settingAccessPolicy').value,
            retry_count: document.getElementById('settingRetryCount').value,
            max_upload_mb: document.getElementById('settingMaxUpload').value
        };
        const res = await fetch('/api/admin/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) beautifulAlert.toast('è®¾ç½®ä¿å­˜æˆåŠŸ!', 'success');
        else beautifulAlert.alert('ä¿å­˜å¤±è´¥!', 'error');
    }
    async function loadAPITokens() {
        const tokens = await (await fetch('/api/user/tokens')).json();
        const apiTokensList = document.getElementById('apiTokensList');
        apiTokensList.innerHTML = '';
        if (tokens && tokens.length > 0) {
            tokens.forEach(token => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${token.Name}</td>
                    <td><code>${token.Token}</code></td>
                    <td><span class="status-badge status-${token.IsActive ? 'active' : 'failed'}">${token.IsActive ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                    <td>${new Date(token.CreatedAt).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-small ${token.IsActive ? 'btn-danger' : 'btn-success'}" onclick="toggleAPITokenStatus(${token.ID})">${token.IsActive ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        <button class="btn btn-danger btn-small" onclick="deleteAPIToken(${token.ID})">åˆ é™¤</button>
                    </td>`;
                apiTokensList.appendChild(tr);
            });
        } else {
            apiTokensList.innerHTML = '<tr><td colspan="5">æš‚æ— API Token</td></tr>';
        }
    }
    
    async function deleteBackend(id) {
        if (!confirm('ç¡®å®šåˆ é™¤æ­¤åç«¯å—?')) return;
        const res = await fetch(`/api/admin/backends/${id}`, {method: 'DELETE'});
        if(!res.ok) {
            const err = await res.json();
            beautifulAlert.alert('åˆ é™¤å¤±è´¥: ' + (err.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
        loadBackends();
    }
    async function toggleBackend(id, flag) {
        if (!flag) {
            console.error("Toggle flag is missing!");
            return;
        }
        await fetch(`/api/admin/backends/${id}/toggle/${flag}`, {method: 'POST'});
        loadBackends();
    }
    async function deleteUser(id) {
        if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·å—?')) return;
        await fetch(`/api/admin/users/${id}`, {method: 'DELETE'});
        loadUsers();
    }
    async function resetUserPassword(id) {
        const newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç :');
        if (!newPassword) return;
        const res = await fetch(`/api/admin/users/${id}/reset-password`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password: newPassword})
        });
        if (res.ok) beautifulAlert.toast('å¯†ç é‡ç½®æˆåŠŸ!', 'success');
        else beautifulAlertalert('é‡ç½®å¤±è´¥!', 'error');
    }
    async function deleteAPIToken(id) {
        if (!confirm('ç¡®å®šåˆ é™¤æ­¤Tokenå—?')) return;
        await fetch(`/api/user/tokens/${id}`, {method: 'DELETE'});
        loadAPITokens();
    }
    async function toggleAPITokenStatus(id) {
        await fetch(`/api/user/tokens/${id}/toggle`, {method: 'POST'});
        loadAPITokens();
    }
    
    function closeModal(modalId) { 
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            modal.innerHTML = ''; 
        }
    }
    async function showModal(id, content) {
        const modal = document.getElementById(id);
        if (!modal) return;
        
        modal.innerHTML = `<div class="modal-content">${content}</div>`;
        modal.classList.add('active');
        
        const form = modal.querySelector('form');
        if (form) {
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            newForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                try {
                    const formData = new FormData(e.target);
                    const payload = Object.fromEntries(formData.entries());
                    
                    let url = e.target.action;
                    let method = e.target.method;
                    
                    if (id === 'addBackendModal' && currentEditingBackendId) {
                        url = `/api/admin/backends/${currentEditingBackendId}`;
                        method = 'PUT';
                    }
                    
                    if (id === 'addBackendModal') {
                        const config = {};
                        modal.querySelectorAll('#configFields .form-control').forEach(input => {
                            config[input.name] = input.value;
                        });
                        
                        payload.Name = payload.name;
                        payload.Type = payload.type;
                        payload.Priority = parseInt(payload.priority || 1);
                        payload.Config = config;
                        
                        delete payload.name;
                        delete payload.type;
                        delete payload.priority;
                    }
                    
                    const res = await fetch(url, {
                        method: method.toUpperCase(),
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (res.ok) {
                        beautifulAlert.alert('æ“ä½œæˆåŠŸ!', 'success');
                        closeModal(id);
                        
                        if (id === 'addUserModal' || id === 'changePasswordModal') loadUsers();
                        if (id === 'createAPITokenModal') loadAPITokens();
                        if (id === 'addBackendModal') loadBackends();
                    } else {
                        const err = await res.json();
                        beautifulAlert.alert('æ“ä½œå¤±è´¥: ' + (err.error || 'æœªçŸ¥æœåŠ¡å™¨é”™è¯¯'), 'error');
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    beautifulAlert.alert('è¯·æ±‚å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚', 'error');
                }
                
                return false;
            });
        }
    }
    function showAddUserModal() {
        showModal('addUserModal', `
            <div class="modal-header"><h2 class="modal-title">æ·»åŠ ç”¨æˆ·</h2></div>
            <form action="/api/admin/users" method="post">
                <div class="form-group"><label>ç”¨æˆ·å</label><input type="text" class="form-control" name="username" required></div>
                <div class="form-group"><label>å¯†ç </label><input type="password" class="form-control" name="password" required></div>
                <div class="form-group"><label>è§’è‰²</label><select class="form-control" name="role"><option value="user">ç”¨æˆ·</option><option value="admin">ç®¡ç†å‘˜</option></select></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('addUserModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">æ·»åŠ </button></div>
            </form>`);
    }
    function showChangePasswordModal() {
        showModal('changePasswordModal', `
            <div class="modal-header"><h2 class="modal-title">ä¿®æ”¹æˆ‘çš„å¯†ç </h2></div>
            <form action="/api/user/change-password" method="post">
                <div class="form-group"><label>æ—§å¯†ç </label><input type="password" class="form-control" name="old_password" required></div>
                <div class="form-group"><label>æ–°å¯†ç </label><input type="password" class="form-control" name="new_password" required></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('changePasswordModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿®æ”¹</button></div>
            </form>`);
    }
    function showCreateAPITokenModal() {
        showModal('createAPITokenModal', `
            <div class="modal-header"><h2 class="modal-title">åˆ›å»ºAPI Token</h2></div>
            <form action="/api/user/tokens" method="post">
                <div class="form-group"><label>Tokenåç§°</label><input type="text" class="form-control" name="name" required></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('createAPITokenModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">åˆ›å»º</button></div>
            </form>`);
    }
    async function showAddBackendModal(id = null) {
        currentEditingBackendId = id;
        
        let content = `
            <div class="modal-header"><h2 class="modal-title">${id ? 'ç¼–è¾‘' : 'æ·»åŠ '}åç«¯</h2></div>
            <form action="/api/admin/backends" method="post">
                <div class="form-group"><label>åç§°</label><input type="text" class="form-control" name="name" required></div>
                <div class="form-group"><label>ç±»å‹</label><select class="form-control" name="type" onchange="updateConfigFields(this.value)"><option value="local">æœ¬åœ°</option><option value="sm.ms">SM.MS</option></select></div>
                <div class="form-group"><label>ä¼˜å…ˆçº§</label><input type="number" class="form-control" name="priority" value="1" required></div>
                <div id="configFields"></div>
                <div id="smmsValidationArea" style="display: none; margin-top: 15px; text-align: right;">
                    <button type="button" class="btn btn-primary" onclick="validateSmmsConnection()">éªŒè¯è¿æ¥</button>
                    <span id="smmsValidationResult" style="margin-left: 10px;"></span>
                </div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('addBackendModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿å­˜</button></div>
            </form>`;
        
        await showModal('addBackendModal', content);
        
        if (id) {
            const backends = await (await fetch('/api/admin/backends/all')).json();
            const backend = backends.find(b => b.ID === id);
            if (backend) {
                const modal = document.getElementById('addBackendModal');
                modal.querySelector('[name="name"]').value = backend.Name;
                modal.querySelector('[name="type"]').value = backend.Type;
                modal.querySelector('[name="priority"]').value = backend.Priority;
                updateConfigFields(backend.Type, backend.Config);
            }
        } else {
            updateConfigFields('local', {});
        }
    }
    function updateConfigFields(type, config = {}) {
        const container = document.getElementById('configFields');
        const smmsArea = document.getElementById('smmsValidationArea');
        smmsArea.style.display = 'none';
        if (type === 'local') {
            container.innerHTML = `
                <div class="form-group"><label>å­˜å‚¨è·¯å¾„</label><input class="form-control" name="storagePath" value="${config.storagePath || 'uploads'}"></div>
                <div class="form-group"><label>è®¿é—®URLå‰ç¼€</label><input class="form-control" name="publicUrl" value="${config.publicUrl || 'http://127.0.0.1:8080'}"></div>`;
        } else if (type === 'sm.ms') {
            smmsArea.style.display = 'block';
            container.innerHTML = `
                <div class="form-group"><label>API URL</label><input class="form-control" name="baseURL" value="${config.baseURL || 'https://smms.app/api/v2/'}"></div>
                <div class="form-group"><label>API Token</label><input type="password" class="form-control" name="token" value="${config.token || ''}"></div>`;
        }
    }
    async function validateSmmsConnection() {
        const modal = document.getElementById('addBackendModal');
        const baseURL = modal.querySelector('[name="baseURL"]').value;
        const token = modal.querySelector('[name="token"]').value;
        const resultSpan = document.getElementById('smmsValidationResult');
        resultSpan.textContent = 'éªŒè¯ä¸­...';
        const res = await fetch('/api/admin/backends/smms/validate-token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ baseURL, token })
        });
        const result = await res.json();
        resultSpan.textContent = result.message;
        resultSpan.style.color = result.success ? 'green' : 'red';
    }
    </script>
</body>
</html>