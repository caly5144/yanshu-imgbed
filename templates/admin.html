<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›é™å›¾åºŠ - åå°ç®¡ç†</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <script src="/static/js/toast.js" defer></script>
    <script>
        function checkAuth() {
            if (!localStorage.getItem('jwt_token')) {
                localStorage.setItem('redirect_after_login', window.location.pathname);
                window.location.href = '/login';
            }
        }
        checkAuth();

        function fetchWithAuth(url, options) {
            options = options || {};
            options.headers = options.headers || {};
            const token = localStorage.getItem('jwt_token');
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            return fetch(url, options).then(response => {
                if (response.status === 401) {
                    // Only handle 401 for potential token expiry.
                    // Let local handlers deal with 403 (Forbidden) etc.
                    console.error("Authentication expired or invalid, redirecting...");
                    logout();
                }
                return response;
            });
        }
    </script>
</head>
<body>
    <script>document.body.classList.add('js-loading');</script>
    <div class="container">
        <div class="header">
            <h1>å›¾åºŠç®¡ç†åå°</h1>
            <div class="header-actions">
                <a href="/">ğŸ“· è¿”å›ä¸»é¡µ</a>
                <a href="#" onclick="logout()">ğŸšª é€€å‡ºç™»å½•</a>
            </div>
        </div>
        <div class="tabs">
            <!-- Tabs will be rendered by JavaScript -->
        </div>
        <div class="content">
            <div id="overview" class="section"></div>
            <div id="images" class="section"></div>
            <div id="tasks" class="section"></div>
            <div id="backends" class="section"></div>
            <div id="settings" class="section"></div>
            <div id="users" class="section"></div>
        </div>
    </div>
    <div class="modal" id="addBackendModal"></div>
    <div class="modal" id="addUserModal"></div>
    <div class="modal" id="changePasswordModal"></div>
    <div class="modal" id="createAPITokenModal"></div>
    <div class="modal" id="batchBackfillModal"></div>
    
    <script>
    let currentPage = 1;
    let selectedImages = new Set();
    let currentEditingBackendId = null;
    let userRole = ''; // Will hold 'admin' or 'user'

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const userInfoRes = await fetchWithAuth('/api/user/info');
            if (userInfoRes.ok) {
                const userInfo = await userInfoRes.json();
                userRole = userInfo.role;
                localStorage.setItem('user_id', userInfo.user_id);
                localStorage.setItem('user_role', userRole);

                renderTabsBasedOnRole();

                const lastTab = localStorage.getItem('activeAdminTab') || 'overview';
                showSection(lastTab);
            } else {
                logout();
                return;
            }
        } catch (error) {
            console.error("Initialization failed:", error);
            logout();
        } finally {
            document.body.classList.remove('js-loading');
        }
    });

    function renderTabsBasedOnRole() {
        const tabsContainer = document.querySelector('.tabs');
        let tabsHtml = `
            <button class="tab" onclick="showSection('overview')">ğŸ“Š æ¦‚è§ˆ</button>
            <button class="tab" onclick="showSection('images')">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</button>
        `;

        if (userRole === 'admin') {
            tabsHtml += `
                <button class="tab" onclick="showSection('tasks')">âš™ï¸ æ‰¹é‡ä»»åŠ¡</button>
                <button class="tab" onclick="showSection('backends')">ğŸ’¾ å­˜å‚¨åç«¯</button>
                <button class="tab" onclick="showSection('settings')">âš¡ ç³»ç»Ÿè®¾ç½®</button>
            `;
        }
        
        const userManagementTabText = userRole === 'admin' ? 'ğŸ‘¥ ç”¨æˆ·ç®¡ç†' : 'ğŸ‘¤ è´¦æˆ·ç®¡ç†';
        tabsHtml += `<button class="tab" onclick="showSection('users')">${userManagementTabText}</button>`;
        
        tabsContainer.innerHTML = tabsHtml;
    }

    function showSection(sectionId) {
        const adminSections = ['tasks', 'backends', 'settings'];
        if (userRole !== 'admin' && adminSections.includes(sectionId)) {
            beautifulAlert.alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢ã€‚', 'error');
            sectionId = 'overview';
        }
        if (userRole !== 'admin' && !['overview', 'images', 'users'].includes(localStorage.getItem('activeAdminTab'))) {
             sectionId = 'overview';
        }

        localStorage.setItem('activeAdminTab', sectionId);
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const tabButton = document.querySelector(`.tab[onclick="showSection('${sectionId}')"]`);
        if (tabButton) tabButton.classList.add('active');
        const section = document.getElementById(sectionId);

        if (section) {
            section.classList.add('active');
            switch (sectionId) {
                case 'overview': loadOverview(); break;
                case 'images': loadImages(1); break;
                case 'tasks': if (userRole === 'admin') loadTasks(); break;
                case 'backends': if (userRole === 'admin') loadBackends(); break;
                case 'settings': if (userRole === 'admin') loadSettings(); break;
                case 'users': loadUsers(); break;
            }
        }
    }
    
    async function loadOverview() {
        const section = document.getElementById('overview');
        section.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="totalImages">...</div><div class="stat-label">æ€»å›¾ç‰‡æ•°</div></div>
                <div class="stat-card"><div class="stat-value" id="totalSize">...</div><div class="stat-label">æ€»å ç”¨ç©ºé—´</div></div>
                <div class="stat-card"><div class="stat-value" id="totalBackends">...</div><div class="stat-label">å­˜å‚¨åç«¯</div></div>
                <div class="stat-card"><div class="stat-value" id="todayUploads">...</div><div class="stat-label">ä»Šæ—¥ä¸Šä¼ </div></div>
            </div>
            <h3 style="margin-bottom: 15px;">æœ€è¿‘ä¸Šä¼ </h3>
            <div class="image-grid" id="recentImages">åŠ è½½ä¸­...</div>`;
        const stats = await (await fetchWithAuth('/api/stats')).json();
        const recentData = await (await fetchWithAuth('/api/images/recent')).json();
        document.getElementById('totalImages').textContent = stats.totalImages;
        document.getElementById('totalSize').textContent = formatSize(stats.totalSize);
        document.getElementById('totalBackends').textContent = stats.totalBackends;
        document.getElementById('todayUploads').textContent = stats.todayUploads;

        const recentGrid = document.getElementById('recentImages');
        recentGrid.innerHTML = '';
        if (recentData && recentData.length > 0) {
            recentData.forEach(img => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.innerHTML = `<img src="/image/${img.UUID}.jpg" alt="${img.OriginalFilename}"><div class="image-item-info">${img.OriginalFilename}</div>`;
                recentGrid.appendChild(item);
            });
        } else {
            recentGrid.innerHTML = '<p>æš‚æ— å›¾ç‰‡</p>';
        }
    }
    
    async function loadImages(page = 1, keyword = '') { // å¢åŠ äº† keyword å‚æ•°
        currentPage = page;
        const section = document.getElementById('images');
        
        let batchActionBarHTML = `
            <span>å·²é€‰ä¸­ <strong id="selectionCount">0</strong> å¼ å›¾ç‰‡</span>
            <button class="btn btn-danger" onclick="handleBatchDelete()">æ‰¹é‡åˆ é™¤</button>
            <button class="btn btn-primary" onclick="handleBatchBackfill()">æ‰¹é‡è¡¥ä¼ </button>
        `;
        if (userRole === 'admin') {
            batchActionBarHTML += `
                <button class="btn btn-success" onclick="handleBatchSetRandom(true)">æ‰¹é‡åŠ å…¥éšæœºå›¾åº“</button>
                <button class="btn btn-danger" onclick="handleBatchSetRandom(false)">æ‰¹é‡ç§»é™¤éšæœºå›¾åº“</button>
            `;
        }

        section.innerHTML = `
            <div id="batchActionBar" style="margin-bottom: 15px;">${batchActionBarHTML}</div>
            <div style="margin-bottom: 15px;">
                <input id="imageSearchInput" type="text" placeholder="æœç´¢å›¾ç‰‡..." style="width: 300px; display: inline-block;" value="${keyword}">
                <button class="btn btn-primary" onclick="searchImages()">æœç´¢</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"></th>
                        <th>é¢„è§ˆ</th><th>æ–‡ä»¶å</th><th>å°ºå¯¸</th><th>å¤§å°</th><th>ä¸Šä¼ æ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="imagesList"></tbody>
            </table>
            <div id="paginationControls" class="pagination-controls"></div>`;

        const imagesList = section.querySelector('#imagesList');
        imagesList.innerHTML = `<tr><td colspan="8">åŠ è½½ä¸­...</td></tr>`;

        const data = await (await fetchWithAuth(`/api/images?page=${page}&pageSize=10&keyword=${encodeURIComponent(keyword)}`)).json();
        
        // --- æ–°å¢ï¼šåœ¨é‡æ–°æ¸²æŸ“åï¼Œå°†å…‰æ ‡èšç„¦åˆ°è¾“å…¥æ¡†æœ«å°¾ ---
        const keywordInput = document.getElementById('imageSearchInput');
        keywordInput.focus();
        keywordInput.selectionStart = keywordInput.selectionEnd = keywordInput.value.length;
        // --- æ–°å¢ç»“æŸ ---
        
        imagesList.innerHTML = '';
        if (!data.images || data.images.length === 0) {
            imagesList.innerHTML = `<tr><td colspan="8">æš‚æ— å›¾ç‰‡</td></tr>`;
            renderPagination(0, page, 10, keyword); // ä¼ é€’keyword
            return;
        }
        data.images.forEach(image => {
            const tr = document.createElement('tr');
            const isActive = image.StorageLocations?.some(loc => loc.IsActive);
            const statusBadge = `<span class="status-badge status-${isActive ? 'active' : 'failed'}">${isActive ? 'æ­£å¸¸' : 'å¤±æ•ˆ'}</span>`;
            const dimensions = (image.Width > 0 && image.Height > 0) ? `${image.Width}x${image.Height}` : 'N/A';
            const randomIcon = image.AllowRandom ? `<svg class="random-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>` : '';

            tr.innerHTML = `
                <td><input type="checkbox" class="image-checkbox" data-uuid="${image.UUID}" onchange="updateSelection()"></td>
                <td><img src="/image/${image.UUID}.jpg" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"></td>
                <td>${image.OriginalFilename || 'N/A'}${randomIcon}</td>
                <td>${dimensions}</td>
                <td>${formatSize(image.FileSize)}</td>
                <td>${new Date(image.CreatedAt).toLocaleString()}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="window.open('/admin/images/${image.UUID}', '_blank')">æŸ¥çœ‹</button>
                    <button class="btn btn-primary btn-small" onclick="copyLink('${window.location.origin}/image/${image.UUID}.jpg')">å¤åˆ¶</button>
                    <button class="btn btn-danger btn-small" onclick="deleteImage('${image.UUID}')">åˆ é™¤</button>
                </td>`;
            tr.querySelector('.image-checkbox').checked = selectedImages.has(image.UUID);
            imagesList.appendChild(tr);
        });
        renderPagination(data.total, data.page, data.pageSize, keyword); // ä¼ é€’keyword
        updateSelection();
    }
    
    // searchImages å‡½æ•°ä¿®æ”¹
    function searchImages() {
        const keywordInput = document.getElementById('imageSearchInput');
        const keyword = keywordInput ? keywordInput.value.trim() : '';
        loadImages(1, keyword); // å°†è¯»å–åˆ°çš„ keyword ä¼ é€’è¿›å»
    }

    // goToPage å‡½æ•°ä¿®æ”¹
    function goToPage(totalPages, keyword = '') { // å¢åŠ  keyword å‚æ•°
        const input = document.getElementById('pageInput');
        if (!input) return;
        const page = parseInt(input.value);
        if (!isNaN(page) && page > 0 && page <= totalPages) {
            loadImages(page, keyword); // ä¼ é€’ keyword
        } else {
            beautifulAlert.alert(`è¯·è¾“å…¥ä¸€ä¸ª 1 åˆ° ${totalPages} ä¹‹é—´çš„æœ‰æ•ˆé¡µç ã€‚`, 'warning');
            input.value = '';
        }
    }

    // renderPagination å‡½æ•°ä¿®æ”¹
    function renderPagination(total, page, pageSize, keyword = '') { // å¢åŠ  keyword å‚æ•°
        const controls = document.getElementById('paginationControls');
        if (!controls) return;
        
        const totalPages = Math.ceil(total / pageSize);
        if (totalPages <= 1) {
            controls.innerHTML = '';
            return;
        }

        let pageControlsHtml = '<div class="pagination-pages">';
        const maxVisiblePages = 5;
        let startPage, endPage;

        if (totalPages <= maxVisiblePages + 2) {
            startPage = 1;
            endPage = totalPages;
        } else {
            const maxPagesBeforeCurrent = Math.floor(maxVisiblePages / 2);
            const maxPagesAfterCurrent = Math.ceil(maxVisiblePages / 2) - 1;
            if (page <= maxPagesBeforeCurrent + 1) {
                startPage = 1;
                endPage = maxVisiblePages;
            } else if (page + maxPagesAfterCurrent >= totalPages) {
                startPage = totalPages - maxVisiblePages + 1;
                endPage = totalPages;
            } else {
                startPage = page - maxPagesBeforeCurrent;
                endPage = page + maxPagesAfterCurrent;
            }
        }
        
        pageControlsHtml += `<button class="btn btn-secondary" onclick="loadImages(1, '${keyword}')" ${page === 1 ? 'disabled' : ''}>Â« é¦–é¡µ</button>`;
        pageControlsHtml += `<button class="btn btn-secondary" onclick="loadImages(${page - 1}, '${keyword}')" ${page === 1 ? 'disabled' : ''}>â€¹ ä¸Šä¸€é¡µ</button>`;
        
        if (startPage > 1) {
            pageControlsHtml += `<span class="pagination-ellipsis">...</span>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            pageControlsHtml += `<button class="btn ${i === page ? 'btn-primary' : 'btn-secondary'}" onclick="loadImages(${i}, '${keyword}')">${i}</button>`;
        }

        if (endPage < totalPages) {
            pageControlsHtml += `<span class="pagination-ellipsis">...</span>`;
        }
        
        pageControlsHtml += `<button class="btn btn-secondary" onclick="loadImages(${page + 1}, '${keyword}')" ${page === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ â€º</button>`;
        pageControlsHtml += `<button class="btn btn-secondary" onclick="loadImages(${totalPages}, '${keyword}')" ${page === totalPages ? 'disabled' : ''}>æœ«é¡µ Â»</button>`;
        
        pageControlsHtml += `
            <div class="pagination-jump" style="margin-left: 16px;">
                <input type="number" id="pageInput" class="form-control" style="width: 80px; height: 40px; text-align: center;" min="1" max="${totalPages}" placeholder="é¡µç " onkeydown="if(event.key==='Enter') goToPage(${totalPages}, '${keyword}')">
                <button class="btn btn-primary" style="height: 40px;" onclick="goToPage(${totalPages}, '${keyword}')">è·³è½¬</button>
            </div>
        `;

        pageControlsHtml += '</div>';

        const startItem = (page - 1) * pageSize + 1;
        const endItem = Math.min(page * pageSize, total);
        const infoHtml = `<div class="pagination-info">æ˜¾ç¤º ${startItem} - ${endItem} / å…± ${total} æ¡</div>`;

        controls.innerHTML = pageControlsHtml + infoHtml;
    }
    
    async function handleBatchSetRandom(isAdding) {
        if (selectedImages.size === 0) {
            beautifulAlert.alert("è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚", "warning");
            return;
        }
        const actionText = isAdding ? 'åŠ å…¥' : 'ç§»é™¤';
        const confirmed = await beautifulAlert.confirm(`ç¡®å®šå°†é€‰ä¸­çš„ ${selectedImages.size} å¼ å›¾ç‰‡${actionText}éšæœºå›¾åº“å—?`);
        if (!confirmed) return;

        const action = isAdding ? 'add_to_random' : 'remove_from_random';
        const res = await fetchWithAuth('/api/admin/images/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: action,
                image_uuids: Array.from(selectedImages)
            })
        });
        
        if (res.ok) {
            beautifulAlert.toast(`æ‰¹é‡${actionText}æˆåŠŸ!`, 'success');
            selectedImages.clear();
            loadImages(currentPage);
        } else {
            const err = await res.json();
            beautifulAlert.alert(`æ‰¹é‡${actionText}å¤±è´¥: ` + (err.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    }

    async function loadTasks() {
        const section = document.getElementById('tasks');
        section.innerHTML = `<h3>è¿›è¡Œä¸­çš„æ‰¹é‡ä»»åŠ¡</h3>
            <table>
                <thead><tr><th>ä»»åŠ¡ID</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>è¿›åº¦</th><th>åˆ›å»ºæ—¶é—´</th></tr></thead>
                <tbody id="tasksList"><tr><td colspan="5">åŠ è½½ä¸­...</td></tr></tbody>
            </table>`;
        const res = await fetchWithAuth('/api/admin/tasks');
        const tasks = res.ok ? await res.json() : [];
        const tasksList = document.getElementById('tasksList');
        tasksList.innerHTML = '';
        if (tasks && tasks.length > 0) {
            tasks.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            tasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${task.id.substring(0,8)}...</td><td>${task.type}</td><td>${task.status}</td><td>${task.progress}/${task.total}</td><td>${new Date(task.created_at).toLocaleString()}</td>`;
                tasksList.appendChild(tr);
            });
        } else {
            tasksList.innerHTML = '<tr><td colspan="5">æš‚æ— ä»»åŠ¡</td></tr>';
        }
    }
    
    async function loadBackends() {
        const section = document.getElementById('backends');
        section.innerHTML = `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showAddBackendModal()">æ·»åŠ åç«¯</button>
            </div>
            <table>
                <thead><tr><th>åç§°</th><th>ç±»å‹</th><th>ä¼˜å…ˆçº§</th><th>å…è®¸ä¸Šä¼ </th><th>å…è®¸è·³è½¬</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="backendsList"></tbody>
            </table>`;
        
        const backends = await (await fetchWithAuth('/api/admin/backends/all')).json();
        const backendsList = section.querySelector('#backendsList');
        backendsList.innerHTML = '';
        backends.forEach(backend => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${backend.Name}</td>
                <td>${backend.Type}</td>
                <td>${backend.Priority}</td>
                <td><span class="status-badge status-${backend.AllowUpload ? 'active' : 'failed'}">${backend.AllowUpload ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                <td><span class="status-badge status-${backend.AllowRedirect ? 'active' : 'failed'}">${backend.AllowRedirect ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                <td>${new Date(backend.CreatedAt).toLocaleString()}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="showAddBackendModal(${backend.ID})">ç¼–è¾‘</button>
                    <button class="btn btn-small ${backend.AllowUpload ? 'btn-danger' : 'btn-success'}" onclick="toggleBackend(${backend.ID}, 'upload')">${backend.AllowUpload ? 'ç¦ç”¨ä¸Šä¼ ' : 'å¯ç”¨ä¸Šä¼ '}</button>
                    <button class="btn btn-small ${backend.AllowRedirect ? 'btn-danger' : 'btn-success'}" onclick="toggleBackend(${backend.ID}, 'redirect')">${backend.AllowRedirect ? 'ç¦ç”¨è·³è½¬' : 'å¯ç”¨è·³è½¬'}</button>
                    <button class="btn btn-danger btn-small" onclick="deleteBackend(${backend.ID})">åˆ é™¤</button>
                </td>`;
            backendsList.appendChild(tr);
        });
    }
    async function loadSettings() {
        const section = document.getElementById('settings');
        section.innerHTML = 'åŠ è½½ä¸­...';
        const settings = await (await fetchWithAuth('/api/settings')).json();
        section.innerHTML = `
            <div class="form-group">
                <label class="form-label">è®¿é—®ç­–ç•¥</label>
                <select id="settingAccessPolicy" class="form-control" style="width: 300px;"><option value="random">éšæœº</option><option value="priority">ä¼˜å…ˆçº§</option></select>
            </div>
            <div class="form-group">
                <label class="form-label">å¤±è´¥é‡è¯•æ¬¡æ•°</label>
                <input id="settingRetryCount" type="number" class="form-control" style="width: 300px;">
                <small style="color: var(--text-secondary); margin-top: 4px; display: block;">è®¾ç½®ä¸º 0 ä»£è¡¨æ— é™æ¬¡é‡è¯•ï¼Œé“¾æ¥æ°¸ä¸å› å¤±è´¥è€Œå¤±æ•ˆã€‚</small>
            </div>
            <div class="form-group">
                <label class="form-label">æœ€å¤§ä¸Šä¼ (MB)</label>
                <input id="settingMaxUpload" type="number" class="form-control" style="width: 300px;">
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>`;
        
        document.getElementById('settingAccessPolicy').value = settings.access_policy;
        document.getElementById('settingRetryCount').value = settings.retry_count;
        document.getElementById('settingMaxUpload').value = settings.max_upload_mb;
    }
    
    async function loadUsers() {
        const section = document.getElementById('users');
        if (userRole === 'admin') {
            section.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showAddUserModal()">æ·»åŠ ç”¨æˆ·</button>
                    <button class="btn btn-primary" onclick="showChangePasswordModal()">ä¿®æ”¹æˆ‘çš„å¯†ç </button>
                </div>
                <table>
                    <thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>è§’è‰²</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="usersList"></tbody>
                </table>
                <h3 style="margin-top: 30px; margin-bottom: 15px;">æˆ‘çš„API Token</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showCreateAPITokenModal()">åˆ›å»ºæ–°Token</button>
                </div>
                <table>
                    <thead><tr><th>åç§°</th><th>Tokenå€¼</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="apiTokensList"></tbody>
                </table>`;
            
            const users = await (await fetchWithAuth('/api/admin/users')).json();
            const usersList = section.querySelector('#usersList');
            usersList.innerHTML = '';
            const currentUserID = parseInt(localStorage.getItem('user_id'));
            users.forEach(user => {
                const tr = document.createElement('tr');
                let actions = `<button class="btn btn-primary btn-small" onclick="resetUserPassword(${user.ID})">é‡ç½®å¯†ç </button>`;
                if (user.ID !== currentUserID) {
                    actions += ` <button class="btn btn-danger btn-small" onclick="deleteUser(${user.ID})">åˆ é™¤</button>`;
                }
                tr.innerHTML = `<td>${user.ID}</td><td>${user.Username}</td><td>${user.Role}</td><td>${new Date(user.CreatedAt).toLocaleString()}</td><td>${actions}</td>`;
                usersList.appendChild(tr);
            });
        } else {
            // User view
            section.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="showChangePasswordModal()">ä¿®æ”¹æˆ‘çš„å¯†ç </button>
                </div>
                <h3 style="margin-top: 30px; margin-bottom: 15px;">æˆ‘çš„API Token</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="showCreateAPITokenModal()">åˆ›å»ºæ–°Token</button>
                </div>
                <table>
                    <thead><tr><th>åç§°</th><th>Tokenå€¼</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="apiTokensList"></tbody>
                </table>`;
        }
        loadAPITokens();
    }
    

    function toggleSelectAll(checked) {
        document.querySelectorAll('.image-checkbox').forEach(cb => cb.checked = checked);
        updateSelection();
    }
    function updateSelection() {
        document.querySelectorAll('.image-checkbox').forEach(cb => {
            if (cb.checked) selectedImages.add(cb.dataset.uuid);
            else selectedImages.delete(cb.dataset.uuid);
        });
        const countSpan = document.getElementById('selectionCount');
        if (countSpan) countSpan.textContent = selectedImages.size;
        const allPageCheckboxes = document.querySelectorAll('.image-checkbox');
        const allPageSelected = allPageCheckboxes.length > 0 && Array.from(allPageCheckboxes).every(cb => cb.checked);
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) selectAllCheckbox.checked = allPageSelected;
    }

    async function handleBatchDelete() {
        if (selectedImages.size === 0) { beautifulAlert.alert("è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚", 'warning'); return; }
        const confirmed = await beautifulAlert.confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedImages.size} å¼ å›¾ç‰‡å—?`);
        if (!confirmed) return;
        const endpoint = userRole === 'admin' ? '/api/admin/images/batch' : '/api/images/batch';
        const res = await fetchWithAuth(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', image_uuids: Array.from(selectedImages) })
        });
        if (res.ok) {
            beautifulAlert.toast('æ‰¹é‡åˆ é™¤ä»»åŠ¡å·²å¼€å§‹','success');
            selectedImages.clear();
            loadImages(currentPage);
            if (userRole === 'admin') showSection('tasks');
        } else {
             const err = await res.json();
             beautifulAlert.alert('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + (err.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    }
    async function handleBatchBackfill() {
        if (selectedImages.size === 0) {
            beautifulAlert.alert("è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚", "warning");
            return;
        }
        
        const backends = await (await fetchWithAuth('/api/backends')).json();
        if (!backends || backends.length === 0) {
            beautifulAlert.alert("æ²¡æœ‰å¯ç”¨çš„å­˜å‚¨åç«¯ã€‚", 'error');
            return;
        }
        const options = backends.map(b => `<option value="${b.ID}">${b.Name} (${b.Type})</option>`).join('');
        showModal('batchBackfillModal', `
            <div class="modal-header"><h2 class="modal-title">æ‰¹é‡è¡¥ä¼ </h2></div>
            <div class="form-group">
                <label>é€‰æ‹©è¦è¡¥ä¼ åˆ°çš„ç›®æ ‡åç«¯:</label>
                <select id="backendSelect" class="form-control">${options}</select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('batchBackfillModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmBackfill()">å¼€å§‹è¡¥ä¼ </button>
            </div>
        `);
    }
    async function confirmBackfill() {
        const backendId = document.getElementById('backendSelect').value;
        if (!backendId) {
            beautifulAlert.alert("è¯·é€‰æ‹©ä¸€ä¸ªåç«¯ã€‚", "warning");
            return;
        }
        const endpoint = userRole === 'admin' ? '/api/admin/images/batch' : '/api/images/batch';
        const res = await fetchWithAuth(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'backfill',
                image_uuids: Array.from(selectedImages),
                backend_id: parseInt(backendId)
            })
        });
        if (res.ok) {
            beautifulAlert.toast('æ‰¹é‡è¡¥ä¼ ä»»åŠ¡å·²å¼€å§‹ã€‚', 'info');
            closeModal('batchBackfillModal');
            selectedImages.clear();
            loadImages(currentPage);
            if (userRole === 'admin') showSection('tasks');
        } else {
            const err = await res.json();
            beautifulAlert.alert('ä»»åŠ¡å¼€å§‹å¤±è´¥: ' + (err.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    }
    function copyLink(link) { navigator.clipboard.writeText(link).then(() => beautifulAlert.toast('é“¾æ¥å·²å¤åˆ¶!', 'success')); }
    async function deleteImage(uuid) {
        const confirmed = await beautifulAlert.confirm('ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ');
        if (!confirmed) return;
        await fetchWithAuth(`/api/images/${uuid}`, { method: 'DELETE' });
        selectedImages.delete(uuid);
        loadImages(currentPage);
    }
    function formatSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
    }
    function logout() { localStorage.clear(); window.location.href = '/login'; }
    
    async function saveSettings() {
        const payload = {
            access_policy: document.getElementById('settingAccessPolicy').value,
            retry_count: document.getElementById('settingRetryCount').value,
            max_upload_mb: document.getElementById('settingMaxUpload').value
        };
        const res = await fetchWithAuth('/api/admin/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) beautifulAlert.toast('è®¾ç½®ä¿å­˜æˆåŠŸ!', 'success');
        else beautifulAlert.alert('ä¿å­˜å¤±è´¥!', 'error');
    }
    async function loadAPITokens() {
        const tokens = await (await fetchWithAuth('/api/user/tokens')).json();
        const apiTokensList = document.getElementById('apiTokensList');
        apiTokensList.innerHTML = '';
        if (tokens && tokens.length > 0) {
            tokens.forEach(token => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${token.Name}</td>
                    <td><code>${token.Token}</code></td>
                    <td><span class="status-badge status-${token.IsActive ? 'active' : 'failed'}">${token.IsActive ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                    <td>${new Date(token.CreatedAt).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-small ${token.IsActive ? 'btn-danger' : 'btn-success'}" onclick="toggleAPITokenStatus(${token.ID})">${token.IsActive ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        <button class="btn btn-danger btn-small" onclick="deleteAPIToken(${token.ID})">åˆ é™¤</button>
                    </td>`;
                apiTokensList.appendChild(tr);
            });
        } else {
            apiTokensList.innerHTML = '<tr><td colspan="5">æš‚æ— API Token</td></tr>';
        }
    }
    
    async function deleteBackend(id) {
        const confirmed = await beautifulAlert.confirm('ç¡®å®šåˆ é™¤æ­¤åç«¯å—?');
        if(!confirmed) return;
        const res = await fetchWithAuth(`/api/admin/backends/${id}`, {method: 'DELETE'});
        if(!res.ok) {
            const err = await res.json();
            beautifulAlert.alert('åˆ é™¤å¤±è´¥: ' + (err.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
        loadBackends();
    }
    async function toggleBackend(id, flag) {
        if (!flag) {
            console.error("Toggle flag is missing!");
            return;
        }
        await fetchWithAuth(`/api/admin/backends/${id}/toggle/${flag}`, {method: 'POST'});
        loadBackends();
    }
    async function deleteUser(id) {
        const confirmed = await beautifulAlert.confirm('ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·å—?');
        if(!confirmed) return;
        await fetchWithAuth(`/api/admin/users/${id}`, {method: 'DELETE'});
        loadUsers();
    }
    async function resetUserPassword(id) {
        const newPassword = await beautifulAlert.prompt('è¯·è¾“å…¥æ–°å¯†ç :');
        if (!newPassword) return;
        const res = await fetchWithAuth(`/api/admin/users/${id}/reset-password`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password: newPassword})
        });
        if (res.ok) beautifulAlert.toast('å¯†ç é‡ç½®æˆåŠŸ!', 'success');
        else beautifulAlert.alert('é‡ç½®å¤±è´¥!', 'error');
    }
    async function deleteAPIToken(id) {
        const confirmed = await beautifulAlert.confirm('ç¡®å®šåˆ é™¤æ­¤Tokenå—?');
        if(!confirmed) return;
        await fetchWithAuth(`/api/user/tokens/${id}`, {method: 'DELETE'});
        loadAPITokens();
    }
    async function toggleAPITokenStatus(id) {
        await fetchWithAuth(`/api/user/tokens/${id}/toggle`, {method: 'POST'});
        loadAPITokens();
    }
    
    function closeModal(modalId) { 
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            modal.innerHTML = ''; 
        }
    }
    async function showModal(id, content) {
        const modal = document.getElementById(id);
        if (!modal) return;
        
        modal.innerHTML = `<div class="modal-content">${content}</div>`;
        modal.classList.add('active');
        
        const form = modal.querySelector('form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                try {
                    const formData = new FormData(e.target);
                    const payload = Object.fromEntries(formData.entries());
                    
                    let url = e.target.action;
                    let method = e.target.method;
                    
                    if (id === 'addBackendModal' && currentEditingBackendId) {
                        url = `/api/admin/backends/${currentEditingBackendId}`;
                        method = 'PUT';
                    }
                    
                    if (id === 'addBackendModal') {
                        const config = {};
                        modal.querySelectorAll('#configFields .form-control').forEach(input => {
                            config[input.name] = input.value;
                        });
                        
                        payload.Name = payload.name;
                        payload.Type = payload.type;
                        payload.Priority = parseInt(payload.priority || 1);
                        payload.Config = config;
                        
                        delete payload.name;
                        delete payload.type;
                        delete payload.priority;
                    }
                    
                    const res = await fetchWithAuth(url, {
                        method: method.toUpperCase(),
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (res.ok) {
                        beautifulAlert.toast('æ“ä½œæˆåŠŸ!', 'success');
                        closeModal(id);
                        
                        if (id === 'addUserModal' || id === 'changePasswordModal') loadUsers();
                        if (id === 'createAPITokenModal') loadAPITokens();
                        if (id === 'addBackendModal') loadBackends();
                    } else {
                        const err = await res.json();
                        beautifulAlert.alert('æ“ä½œå¤±è´¥: ' + (err.error || 'æœªçŸ¥æœåŠ¡å™¨é”™è¯¯'), 'error');
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    beautifulAlert.alert('è¯·æ±‚å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚', 'error');
                }
            });
        }
    }
    function showAddUserModal() {
        showModal('addUserModal', `
            <div class="modal-header"><h2 class="modal-title">æ·»åŠ ç”¨æˆ·</h2></div>
            <form action="/api/admin/users" method="post">
                <div class="form-group"><label>ç”¨æˆ·å</label><input type="text" class="form-control" name="username" required></div>
                <div class="form-group"><label>å¯†ç </label><input type="password" class="form-control" name="password" required></div>
                <div class="form-group"><label>è§’è‰²</label><select class="form-control" name="role"><option value="user">ç”¨æˆ·</option><option value="admin">ç®¡ç†å‘˜</option></select></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('addUserModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">æ·»åŠ </button></div>
            </form>`);
    }
    function showChangePasswordModal() {
        showModal('changePasswordModal', `
            <div class="modal-header"><h2 class="modal-title">ä¿®æ”¹æˆ‘çš„å¯†ç </h2></div>
            <form action="/api/user/change-password" method="post">
                <div class="form-group"><label>æ—§å¯†ç </label><input type="password" class="form-control" name="old_password" required></div>
                <div class="form-group"><label>æ–°å¯†ç </label><input type="password" class="form-control" name="new_password" required></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('changePasswordModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿®æ”¹</button></div>
            </form>`);
    }
    function showCreateAPITokenModal() {
        showModal('createAPITokenModal', `
            <div class="modal-header"><h2 class="modal-title">åˆ›å»ºAPI Token</h2></div>
            <form action="/api/user/tokens" method="post">
                <div class="form-group"><label>Tokenåç§°</label><input type="text" class="form-control" name="name" required></div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('createAPITokenModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">åˆ›å»º</button></div>
            </form>`);
    }
    async function showAddBackendModal(id = null) {
        currentEditingBackendId = id;
        
        const isEditMode = id !== null;
        const typeSelectDisabled = isEditMode ? 'disabled' : '';

        let content = `
            <div class="modal-header"><h2 class="modal-title">${isEditMode ? 'ç¼–è¾‘' : 'æ·»åŠ '}åç«¯</h2></div>
            <form action="/api/admin/backends" method="post">
                <div class="form-group"><label>åç§°</label><input type="text" class="form-control" name="name" required></div>
                <div class="form-group"><label>ç±»å‹</label><select class="form-control" name="type" onchange="updateConfigFields(this.value)" ${typeSelectDisabled}><option value="local">æœ¬åœ°</option><option value="sm.ms">SM.MS</option><option value="oss">é˜¿é‡Œäº‘OSS</option></select></div>
                <div class="form-group"><label>ä¼˜å…ˆçº§</label><input type="number" class="form-control" name="priority" value="1" required></div>
                <div id="configFields"></div>
                <div id="smmsValidationArea" style="display: none; margin-top: 15px; text-align: right;">
                    <button type="button" class="btn btn-primary" onclick="validateSmmsConnection()">éªŒè¯è¿æ¥</button>
                    <span id="smmsValidationResult" style="margin-left: 10px;"></span>
                </div>
                <div class="modal-footer"><button type="button" class="btn" onclick="closeModal('addBackendModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿å­˜</button></div>
            </form>`;
        
        await showModal('addBackendModal', content);
        
        if (isEditMode) {
            const backends = await (await fetchWithAuth('/api/admin/backends/all')).json();
            const backend = backends.find(b => b.ID === id);
            if (backend) {
                const modal = document.getElementById('addBackendModal');
                modal.querySelector('[name="name"]').value = backend.Name;
                modal.querySelector('[name="type"]').value = backend.Type;
                modal.querySelector('[name="priority"]').value = backend.Priority;
                
                // ç¡®ä¿ config æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åæ›´æ–°å­—æ®µ
                const configObject = (typeof backend.Config === 'string') ? JSON.parse(backend.Config) : backend.Config;
                updateConfigFields(backend.Type, configObject || {});
            }
        } else {
            // å¯¹äºæ–°åç«¯ï¼Œé»˜è®¤æ˜¾ç¤º local çš„é…ç½®
            updateConfigFields('local', {});
        }
    }
    function updateConfigFields(type, config = {}) {
        const container = document.getElementById('configFields');
        const smmsArea = document.getElementById('smmsValidationArea');
        smmsArea.style.display = 'none';

        const isEditMode = currentEditingBackendId !== null;

        if (type === 'local') {
            const storagePathReadonly = isEditMode ? 'readonly' : '';
            const helpText = isEditMode ? '<small style="color: var(--text-secondary); margin-top: 4px; display: block;">å­˜å‚¨è·¯å¾„åœ¨åˆ›å»ºåä¸å¯ä¿®æ”¹ã€‚</small>' : '';
            container.innerHTML = `
                <div class="form-group">
                    <label>å­˜å‚¨è·¯å¾„</label>
                    <input class="form-control" name="storagePath" value="${config.storagePath || 'uploads'}" ${storagePathReadonly}>
                    ${helpText}
                </div>
                <div class="form-group"><label>è®¿é—®URLå‰ç¼€</label><input class="form-control" name="publicUrl" value="${config.publicUrl || 'http://127.0.0.1:3030'}"></div>`;
        } else if (type === 'sm.ms') {
            smmsArea.style.display = 'block';
            container.innerHTML = `
                <div class="form-group"><label>API URL</label><input class="form-control" name="baseURL" value="${config.baseURL || 'https://smms.app/api/v2/'}"></div>
                <div class="form-group"><label>API Token</label><input type="password" class="form-control" name="token" value="${config.token || ''}"></div>`;
        } else if (type === 'oss') {
            container.innerHTML = `
                <div class="form-group"><label>Endpoint</label><input class="form-control" name="endpoint" placeholder="ä¾‹å¦‚: oss-cn-hangzhou.aliyuncs.com" value="${config.endpoint || ''}"></div>
                <div class="form-group"><label>Bucket åç§°</label><input class="form-control" name="bucket" value="${config.bucket || ''}"></div>
                <div class="form-group"><label>AccessKey ID</label><input class="form-control" name="accessKeyId" value="${config.accessKeyId || ''}"></div>
                <div class="form-group"><label>AccessKey Secret</label><input type="password" class="form-control" name="accessKeySecret" value="${config.accessKeySecret || ''}"></div>
                <div class="form-group"><label>è‡ªå®šä¹‰åŸŸå (å¯é€‰)</label><input class="form-control" name="publicUrl" placeholder="ä¾‹å¦‚: https://img.yourdomain.com" value="${config.publicUrl || ''}"></div>
                <div class="form-group"><label>å­˜å‚¨è·¯å¾„å‰ç¼€ (å¯é€‰)</label><input class="form-control" name="uploadPath" placeholder="ä¾‹å¦‚: images/2025" value="${config.uploadPath || ''}"></div>`;
        }
    }
    async function validateSmmsConnection() {
        const modal = document.getElementById('addBackendModal');
        const baseURL = modal.querySelector('[name="baseURL"]').value;
        const token = modal.querySelector('[name="token"]').value;
        const resultSpan = document.getElementById('smmsValidationResult');
        resultSpan.textContent = 'éªŒè¯ä¸­...';
        const res = await fetchWithAuth('/api/admin/backends/smms/validate-token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ baseURL, token })
        });
        const result = await res.json();
        resultSpan.textContent = result.message;
        resultSpan.style.color = result.success ? 'green' : 'red';
    }
    </script>
</body>
</html>

