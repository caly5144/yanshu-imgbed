<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/static/js/toast.js" defer></script>
    <title>å›¾ç‰‡è¯¦æƒ…</title>
    <link rel="stylesheet" href="/static/css/image_detail.css">
    <script>
        (function() {
            if (!localStorage.getItem('jwt_token')) { window.location.href = '/login'; }
            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                options = options || {}; options.headers = options.headers || {};
                const token = localStorage.getItem('jwt_token');
                if (token) { options.headers['Authorization'] = `Bearer ${token}`; }
                return originalFetch(url, options).then(response => {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.clear();
                        window.location.href = '/login';
                    }
                    return response;
                });
            };
        })();
    </script>
</head>
<body>
    <div class="breadcrumb">
        <a href="/admin" target="_blank">åå°ç®¡ç†</a>
        <span>â€º</span>
        <span>å›¾ç‰‡è¯¦æƒ…</span>
    </div>
    
    <div class="details-container">
        <div class="image-preview-pane">
            <img id="imagePreview" src="" alt="Image preview">
        </div>
        <div class="info-pane">
            <div class="info-top">
                <div class="tabs" id="backendTabs"></div>
                <div class="links-area">
                    <div class="link-group">
                        <label>URL</label>
                        <div class="input-with-copy">
                            <input type="text" id="linkUrl" readonly>
                            <button class="btn btn-primary" onclick="copyToClipboard('linkUrl')">å¤åˆ¶</button>
                        </div>
                    </div>
                    <div class="link-group">
                        <label>Markdown</label>
                        <div class="input-with-copy">
                            <input type="text" id="linkMarkdown" readonly>
                            <button class="btn btn-primary" onclick="copyToClipboard('linkMarkdown')">å¤åˆ¶</button>
                        </div>
                    </div>
                    <div class="link-group">
                        <label>HTML</label>
                        <div class="input-with-copy">
                            <input type="text" id="linkHtml" readonly>
                            <button class="btn btn-primary" onclick="copyToClipboard('linkHtml')">å¤åˆ¶</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- --- HTML ç»“æ„ä¿®æ­£ --- -->
            <div class="info-bottom" id="statusArea">
                <h4 style="margin-bottom: 16px; color: var(--text-primary);">åç«¯çŠ¶æ€</h4>
                <div class="status-items-wrapper">
                    <div class="status-item">
                        <strong>å½“å‰çŠ¶æ€</strong>
                        <span id="locationStatus"></span>
                    </div>
                    <div class="status-item">
                        <strong>å¤±è´¥æ¬¡æ•°</strong>
                        <span id="failureCount" style="font-weight: 600;"></span>
                    </div>
                </div>
                <button id="toggleStatusBtn" class="btn"></button>
            </div>
            <div class="info-bottom" id="randomArea" style="display: none;">
                <h4 style="margin-bottom: 16px; color: var(--text-primary);">éšæœºå›¾åº“</h4>
                <div class="status-items-wrapper">
                    <div class="status-item">
                        <strong>å½“å‰çŠ¶æ€</strong>
                        <span id="randomStatus"></span>
                    </div>
                </div>
                <button id="toggleRandomBtn" class="btn"></button>
            </div>
            <!-- --- HTML ç»“æ„ä¿®æ­£ç»“æŸ --- -->

        </div>
    </div>

    <script>
        let imageData = null;
        let currentTab = 'distribution';
        
        function getUuidFromPath() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        }
        
        async function loadImageDetails() {
            const uuid = getUuidFromPath();
            if (!uuid) return;
            document.getElementById('imagePreview').src = `/image/${uuid}.jpg`;
            const response = await fetch(`/api/admin/images/${uuid}`);
            if (!response.ok) {
                beautifulAlert.alert('åŠ è½½å›¾ç‰‡è¯¦æƒ…å¤±è´¥', 'error');
                return;
            }
            imageData = await response.json();
            
            renderTabs();
            selectTab('distribution');
        }
        
        function renderTabs() {
            const tabsContainer = document.getElementById('backendTabs');
            let tabsHtml = '<button class="tab" data-id="distribution" onclick="selectTab(\'distribution\')">ğŸŒ åˆ†å‘</button>';
            imageData.StorageLocations.forEach(loc => {
                tabsHtml += `<button class="tab" data-id="${loc.ID}" onclick="selectTab(${loc.ID})">${loc.Backend.Name}</button>`;
            });
            tabsContainer.innerHTML = tabsHtml;
        }

        /* --- JavaScript é€»è¾‘ä¿®æ­£ --- */
        
        function selectTab(locationIdOrType) {
            currentTab = locationIdOrType;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabElement = document.querySelector(`.tab[data-id="${currentTab}"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            updateInfoForTab();
        }
        
        function updateInfoForTab() {
            const statusArea = document.getElementById('statusArea');
            const randomArea = document.getElementById('randomArea');
            
            let url, filename = imageData.OriginalFilename;
            
            if (currentTab === 'distribution') {
                url = `${window.location.origin}/image/${imageData.UUID}.jpg`;
                statusArea.style.display = 'none';
                randomArea.style.display = 'block';
                updateRandomStatusUI();
            } else {
                const loc = imageData.StorageLocations.find(l => l.ID === currentTab);
                if (!loc) return;
                
                url = loc.URL;
                statusArea.style.display = 'block';
                randomArea.style.display = 'none';

                const statusSpan = document.getElementById('locationStatus');
                const toggleBtn = document.getElementById('toggleStatusBtn');
                statusSpan.textContent = loc.IsActive ? 'æœ‰æ•ˆ' : 'å¤±æ•ˆ';
                statusSpan.className = loc.IsActive ? 'status-badge status-active' : 'status-badge status-failed';
                document.getElementById('failureCount').textContent = loc.FailureCount;
                
                toggleBtn.textContent = loc.IsActive ? 'æ‰‹åŠ¨è®¾ä¸ºå¤±æ•ˆ' : 'æ‰‹åŠ¨è®¾ä¸ºæœ‰æ•ˆ';
                toggleBtn.className = `btn ${loc.IsActive ? 'btn-danger' : 'btn-success'}`;
                toggleBtn.onclick = () => toggleLocationStatus(loc.ID);
            }
            
            document.getElementById('linkUrl').value = url;
            document.getElementById('linkMarkdown').value = `![${filename}](${url})`;
            document.getElementById('linkHtml').value = `<img src="${url}" alt="${filename}">`;
        }

        function updateRandomStatusUI() {
            const randomStatusSpan = document.getElementById('randomStatus');
            const toggleRandomBtn = document.getElementById('toggleRandomBtn');
            
            randomStatusSpan.textContent = imageData.AllowRandom ? 'å·²åŠ å…¥' : 'æœªåŠ å…¥';
            randomStatusSpan.className = imageData.AllowRandom ? 'status-badge status-active' : 'status-badge status-failed';
            
            toggleRandomBtn.textContent = imageData.AllowRandom ? 'ç§»å‡ºéšæœºå›¾åº“' : 'åŠ å…¥éšæœºå›¾åº“';
            toggleRandomBtn.className = `btn ${imageData.AllowRandom ? 'btn-danger' : 'btn-success'}`;
            toggleRandomBtn.onclick = () => toggleRandomStatus();
        }

        async function toggleRandomStatus() {
            const uuid = getUuidFromPath();
            const response = await fetch(`/api/admin/images/${uuid}/toggle-random`, { method: 'POST' });
            if (!response.ok) {
                beautifulAlert.alert('æ›´æ–°çŠ¶æ€å¤±è´¥', 'error');
                return;
            }
            const data = await response.json();
            imageData.AllowRandom = data.allow_random;
            updateRandomStatusUI();
            beautifulAlert.toast('çŠ¶æ€æ›´æ–°æˆåŠŸ!', 'success');
        }
        
        async function toggleLocationStatus(locationId) {
            const response = await fetch(`/api/admin/storagelocations/${locationId}/toggle`, {
                method: 'POST'
            });
            if (!response.ok) {
                beautifulAlert.alert('æ›´æ–°çŠ¶æ€å¤±è´¥', 'error');
                return;
            }
            const updatedLocation = await response.json();
            
            const index = imageData.StorageLocations.findIndex(l => l.ID === locationId);
            if (index !== -1) {
                imageData.StorageLocations[index].IsActive = updatedLocation.IsActive;
            }
            updateInfoForTab();
            beautifulAlert.toast('çŠ¶æ€æ›´æ–°æˆåŠŸ!', 'success');
        }
        
        function copyToClipboard(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            document.execCommand('copy');
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ å·²å¤åˆ¶';
            setTimeout(() => { btn.textContent = originalText; }, 2000);
        }
        
        document.addEventListener('DOMContentLoaded', loadImageDetails);
        /* --- JavaScript é€»è¾‘ä¿®æ­£ç»“æŸ --- */
    </script>
</body>
</html>

